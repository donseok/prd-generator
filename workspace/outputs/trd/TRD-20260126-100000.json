{
  "id": "TRD-20260126-100000",
  "title": "차량 계량대 시스템 재구축 TRD (기술 요구사항 문서)",
  "executive_summary": "본 문서는 차량 계량대 시스템 재구축 프로젝트의 기술 요구사항을 정의합니다. 기존 DOS 기반 레거시 시스템을 대체하여 클라우드 기반의 웹 관리 시스템과 크로스플랫폼 모바일 앱을 구축합니다. 현장의 기존 인디케이터(저울) 3대는 엣지 서버를 통해 RS-232 시리얼 통신으로 연동하며, ERP 시스템과 전광판도 연동합니다. AWS 클라우드 인프라를 활용하여 고가용성과 확장성을 확보합니다.",
  "technology_stack": [
    {
      "category": "Frontend (웹)",
      "technologies": [
        "React 18.x - SPA 프레임워크",
        "TypeScript 5.x - 타입 안정성",
        "TailwindCSS 3.x - 유틸리티 CSS",
        "Zustand 4.x - 경량 상태관리",
        "Recharts 2.x - 대시보드 시각화",
        "Axios 1.x - HTTP 클라이언트",
        "Socket.io-client 4.x - 실시간 통신"
      ],
      "rationale": "React는 대규모 커뮤니티와 풍부한 생태계를 보유하고 있으며, TypeScript와의 조합으로 유지보수성이 향상됩니다."
    },
    {
      "category": "Frontend (모바일)",
      "technologies": [
        "Flutter 3.x - 크로스플랫폼 프레임워크",
        "Dart 3.x - 프로그래밍 언어",
        "Riverpod 2.x - 상태관리",
        "Firebase Cloud Messaging - 푸시 알림",
        "Hive 2.x - 오프라인 로컬 저장소"
      ],
      "rationale": "Flutter는 단일 코드베이스로 iOS/Android 앱을 동시에 개발할 수 있어 개발 효율성이 높습니다."
    },
    {
      "category": "Backend",
      "technologies": [
        "FastAPI 0.100+ - Python 웹 프레임워크",
        "Python 3.11 - 프로그래밍 언어",
        "SQLAlchemy 2.x - ORM (비동기 지원)",
        "Celery 5.x - 비동기 작업 큐",
        "Socket.io 5.x - 실시간 통신"
      ],
      "rationale": "FastAPI는 고성능 비동기 처리와 자동 API 문서화를 지원합니다."
    },
    {
      "category": "Database & Cache",
      "technologies": [
        "PostgreSQL 15.x - 관계형 데이터베이스 (AWS RDS)",
        "Redis 7.x - 캐시 (AWS ElastiCache)",
        "AWS S3 - 파일 저장소"
      ],
      "rationale": "PostgreSQL은 안정성과 성능이 검증된 RDBMS이며, AWS RDS의 Multi-AZ 구성으로 고가용성을 확보합니다."
    },
    {
      "category": "Edge Server (현장)",
      "technologies": [
        "Ubuntu 22.04 LTS - 운영체제",
        "Python 3.11 - 데이터 수집",
        "pyserial 3.x - RS-232 시리얼 통신",
        "SQLite - 오프라인 버퍼 로컬 DB"
      ],
      "rationale": "경량 Linux 환경에서 안정적인 데이터 수집이 가능합니다."
    }
  ],
  "system_architecture": {
    "overview": "시스템은 클라우드(AWS)와 현장(On-Premise) 두 영역으로 구성됩니다. 클라우드에는 웹 앱, API 서버, 데이터베이스가 배치되며, 현장에는 엣지 서버가 인디케이터 및 전광판과 연동됩니다. 두 영역은 AWS Site-to-Site VPN으로 연결됩니다.",
    "architecture_style": "Layered Architecture with Edge Computing",
    "layers": [
      {
        "name": "Presentation Layer",
        "description": "사용자 인터페이스를 제공하는 계층",
        "components": [
          {
            "name": "Web Dashboard",
            "type": "SPA",
            "description": "React 기반 관리자용 웹 대시보드",
            "responsibilities": ["실시간 현황 표시", "통계 리포트", "차량/기사 관리"],
            "dependencies": ["API Layer"],
            "interfaces": ["REST API", "WebSocket"]
          },
          {
            "name": "Mobile App",
            "type": "Native App",
            "description": "Flutter 기반 운전기사용 모바일 앱",
            "responsibilities": ["대기 순번 확인", "푸시 알림 수신", "전자 전표 조회"],
            "dependencies": ["API Layer"],
            "interfaces": ["REST API", "WebSocket", "FCM"]
          }
        ]
      },
      {
        "name": "API Layer",
        "description": "비즈니스 로직과 데이터 접근을 제공하는 계층",
        "components": [
          {
            "name": "API Gateway",
            "type": "Gateway",
            "description": "AWS API Gateway, 인증/라우팅",
            "responsibilities": ["요청 라우팅", "인증 처리", "Rate Limiting"],
            "dependencies": [],
            "interfaces": ["HTTPS"]
          },
          {
            "name": "App Server",
            "type": "Service",
            "description": "FastAPI 기반 애플리케이션 서버",
            "responsibilities": ["비즈니스 로직", "데이터 처리", "외부 연동"],
            "dependencies": ["Data Layer"],
            "interfaces": ["REST API"]
          },
          {
            "name": "WebSocket Server",
            "type": "Service",
            "description": "Socket.io 기반 실시간 통신 서버",
            "responsibilities": ["실시간 데이터 푸시", "대기열 업데이트"],
            "dependencies": ["Data Layer"],
            "interfaces": ["WebSocket"]
          }
        ]
      },
      {
        "name": "Data Layer",
        "description": "데이터 저장 및 캐싱 계층",
        "components": [
          {
            "name": "PostgreSQL",
            "type": "Database",
            "description": "AWS RDS, 메인 데이터 저장소",
            "responsibilities": ["영구 데이터 저장"],
            "dependencies": [],
            "interfaces": ["SQL"]
          },
          {
            "name": "Redis",
            "type": "Cache",
            "description": "AWS ElastiCache, 세션 및 캐싱",
            "responsibilities": ["세션 관리", "데이터 캐싱"],
            "dependencies": [],
            "interfaces": ["Redis Protocol"]
          },
          {
            "name": "S3",
            "type": "Storage",
            "description": "전표 이미지 및 리포트 파일 저장",
            "responsibilities": ["파일 저장"],
            "dependencies": [],
            "interfaces": ["S3 API"]
          }
        ]
      },
      {
        "name": "Edge Layer",
        "description": "현장 데이터 수집 계층",
        "components": [
          {
            "name": "Edge Server",
            "type": "Service",
            "description": "인디케이터 데이터 수집 및 전송",
            "responsibilities": ["시리얼 통신", "데이터 파싱", "API 전송"],
            "dependencies": ["API Layer"],
            "interfaces": ["RS-232", "HTTPS"]
          },
          {
            "name": "Local Buffer",
            "type": "Storage",
            "description": "SQLite 기반 오프라인 버퍼",
            "responsibilities": ["오프라인 데이터 저장"],
            "dependencies": [],
            "interfaces": ["SQL"]
          }
        ]
      }
    ],
    "data_flow": "1. 계량 데이터 흐름: 인디케이터 → Edge Server (RS-232) → API Server (HTTPS/VPN) → PostgreSQL → WebSocket → Web/Mobile\n2. 대기열 흐름: Mobile App → API Server → PostgreSQL → WebSocket → Web Dashboard / 전광판\n3. ERP 연동 흐름: PostgreSQL → Celery Worker → ERP API (일 1회 배치)",
    "deployment_diagram": "AWS 클라우드에 VPC를 구성하고, Public Subnet에 API Gateway와 CloudFront, Private Subnet에 EC2, RDS, ElastiCache를 배치합니다. 현장 엣지 서버와는 Site-to-Site VPN으로 연결합니다."
  },
  "database_design": {
    "database_type": "RDBMS",
    "recommended_engine": "PostgreSQL 15.x",
    "entities": [
      {
        "name": "vehicles",
        "description": "차량 정보를 저장하는 테이블",
        "attributes": [
          "id: UUID PRIMARY KEY",
          "plate_number: VARCHAR(20) NOT NULL UNIQUE",
          "vehicle_type: VARCHAR(50)",
          "empty_weight: DECIMAL(10,2)",
          "max_load: DECIMAL(10,2)",
          "company_id: UUID FK",
          "is_active: BOOLEAN DEFAULT true",
          "created_at: TIMESTAMP",
          "updated_at: TIMESTAMP"
        ],
        "primary_key": "id",
        "relationships": ["companies (N:1)", "drivers (1:N)", "weighings (1:N)"]
      },
      {
        "name": "drivers",
        "description": "운전기사 정보를 저장하는 테이블",
        "attributes": [
          "id: UUID PRIMARY KEY",
          "name: VARCHAR(100) NOT NULL",
          "phone: VARCHAR(20)",
          "company_id: UUID FK",
          "vehicle_id: UUID FK",
          "app_user_id: UUID FK",
          "created_at: TIMESTAMP",
          "updated_at: TIMESTAMP"
        ],
        "primary_key": "id",
        "relationships": ["vehicles (N:1)", "app_users (1:1)", "weighings (1:N)"]
      },
      {
        "name": "weighings",
        "description": "계량 데이터를 저장하는 테이블",
        "attributes": [
          "id: UUID PRIMARY KEY",
          "vehicle_id: UUID FK",
          "driver_id: UUID FK",
          "scale_id: INTEGER NOT NULL",
          "gross_weight: DECIMAL(10,2)",
          "tare_weight: DECIMAL(10,2)",
          "net_weight: DECIMAL(10,2) GENERATED",
          "weighing_time: TIMESTAMP NOT NULL",
          "receipt_number: VARCHAR(50)",
          "status: VARCHAR(20)",
          "created_at: TIMESTAMP"
        ],
        "primary_key": "id",
        "relationships": ["vehicles (N:1)", "drivers (N:1)"]
      },
      {
        "name": "queue",
        "description": "대기열 정보를 저장하는 테이블",
        "attributes": [
          "id: UUID PRIMARY KEY",
          "vehicle_id: UUID FK",
          "driver_id: UUID FK",
          "queue_number: INTEGER NOT NULL",
          "status: VARCHAR(20) DEFAULT 'waiting'",
          "registered_at: TIMESTAMP",
          "called_at: TIMESTAMP",
          "completed_at: TIMESTAMP"
        ],
        "primary_key": "id",
        "relationships": ["vehicles (N:1)", "drivers (N:1)"]
      }
    ],
    "indexing_strategy": "weighings 테이블: weighing_time, vehicle_id, driver_id에 복합 인덱스 생성. queue 테이블: status, registered_at에 인덱스 생성. vehicles 테이블: plate_number에 UNIQUE 인덱스.",
    "partitioning_strategy": "weighings 테이블은 weighing_time 기준 월별 파티셔닝 검토 (데이터 증가 시)"
  },
  "api_specification": {
    "base_url": "/api/v1",
    "authentication_method": "JWT (Bearer Token)",
    "endpoints": [
      {"path": "/weighings", "method": "GET", "description": "계량 목록 조회", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-005"},
      {"path": "/weighings/{id}", "method": "GET", "description": "계량 상세 조회", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-005"},
      {"path": "/weighings", "method": "POST", "description": "계량 데이터 등록", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-010"},
      {"path": "/weighings/{id}", "method": "PUT", "description": "계량 데이터 수정", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-005"},
      {"path": "/weighings/statistics", "method": "GET", "description": "통계 조회", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-002"},
      {"path": "/weighings/export", "method": "GET", "description": "엑셀 다운로드", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-005"},
      {"path": "/queue", "method": "GET", "description": "현재 대기열 조회", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-006"},
      {"path": "/queue", "method": "POST", "description": "대기열 등록", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-006"},
      {"path": "/queue/{id}/call", "method": "PUT", "description": "순번 호출", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-007"},
      {"path": "/queue/{id}", "method": "DELETE", "description": "대기열 취소", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-006"},
      {"path": "/queue/my", "method": "GET", "description": "내 순번 조회 (모바일)", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-006"},
      {"path": "/vehicles", "method": "GET", "description": "차량 목록 조회", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-003"},
      {"path": "/vehicles", "method": "POST", "description": "차량 등록", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-003"},
      {"path": "/vehicles/{id}", "method": "PUT", "description": "차량 수정", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-003"},
      {"path": "/vehicles/{id}", "method": "DELETE", "description": "차량 삭제", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-003"},
      {"path": "/drivers", "method": "GET", "description": "운전기사 목록 조회", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-004"},
      {"path": "/drivers", "method": "POST", "description": "운전기사 등록", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-004"},
      {"path": "/drivers/{id}", "method": "PUT", "description": "운전기사 수정", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "FR-004"},
      {"path": "/auth/login", "method": "POST", "description": "로그인", "request_body": null, "response_body": null, "authentication": false, "related_requirement_id": "NFR-003"},
      {"path": "/auth/refresh", "method": "POST", "description": "토큰 갱신", "request_body": null, "response_body": null, "authentication": true, "related_requirement_id": "NFR-003"}
    ],
    "common_headers": {
      "Content-Type": "application/json",
      "Authorization": "Bearer {token}"
    },
    "error_handling": "표준 HTTP 상태 코드를 사용하며, 에러 응답은 {error: {code, message, details}} 형식을 따릅니다."
  },
  "security_requirements": [
    {"category": "Authentication", "requirement": "사용자 인증", "implementation": "JWT + Refresh Token, OAuth 2.0 (ERP 연동)", "priority": "HIGH"},
    {"category": "Authorization", "requirement": "권한 관리", "implementation": "Role-based Access Control (Admin, Operator, Driver)", "priority": "HIGH"},
    {"category": "Data Protection", "requirement": "전송 암호화", "implementation": "TLS 1.2 이상 필수", "priority": "HIGH"},
    {"category": "Data Protection", "requirement": "저장 암호화", "implementation": "AES-256 (개인정보 필드)", "priority": "HIGH"},
    {"category": "Data Protection", "requirement": "로그 보안", "implementation": "민감정보 마스킹", "priority": "MEDIUM"},
    {"category": "Network", "requirement": "네트워크 보안", "implementation": "VPN (Edge-Cloud), IP Whitelist", "priority": "HIGH"},
    {"category": "API Security", "requirement": "API 보안", "implementation": "Rate Limiting, WAF (SQL Injection, XSS 방어)", "priority": "HIGH"}
  ],
  "performance_requirements": [
    {"metric": "API 응답 시간", "target_value": "200ms 이내 (95 percentile)", "measurement_method": "APM 모니터링", "related_component": "App Server"},
    {"metric": "웹 페이지 로딩", "target_value": "3초 이내", "measurement_method": "Lighthouse 측정", "related_component": "Web Dashboard"},
    {"metric": "모바일 앱 로딩", "target_value": "3초 이내", "measurement_method": "앱 성능 모니터링", "related_component": "Mobile App"},
    {"metric": "동시 접속자", "target_value": "50명 이상", "measurement_method": "부하 테스트 (k6, JMeter)", "related_component": "App Server"},
    {"metric": "데이터베이스 쿼리", "target_value": "100ms 이내", "measurement_method": "Query Plan 분석", "related_component": "PostgreSQL"},
    {"metric": "WebSocket 지연", "target_value": "500ms 이내", "measurement_method": "실시간 모니터링", "related_component": "WebSocket Server"}
  ],
  "infrastructure_requirements": [
    {"category": "Compute", "specification": "EC2 t3.medium", "quantity": "2", "purpose": "Web/API Server (Auto Scaling)", "estimated_cost": null},
    {"category": "Database", "specification": "RDS db.t3.medium", "quantity": "1", "purpose": "PostgreSQL 15 (Multi-AZ)", "estimated_cost": null},
    {"category": "Cache", "specification": "ElastiCache cache.t3.micro", "quantity": "1", "purpose": "Redis 7.x", "estimated_cost": null},
    {"category": "Storage", "specification": "S3 Standard", "quantity": "-", "purpose": "전표 이미지, 리포트 파일", "estimated_cost": null},
    {"category": "CDN", "specification": "CloudFront", "quantity": "-", "purpose": "정적 파일 배포", "estimated_cost": null},
    {"category": "Network", "specification": "VPC + Site-to-Site VPN", "quantity": "1", "purpose": "현장-클라우드 연결", "estimated_cost": null},
    {"category": "Edge", "specification": "Ubuntu Server", "quantity": "1", "purpose": "현장 엣지 서버", "estimated_cost": null}
  ],
  "technical_risks": [
    {"description": "B사 인디케이터 프로토콜 미확보", "level": "MEDIUM", "impact": "연동 개발 지연 가능", "mitigation": "A사 프로토콜 기반 개발 후 B사 대응", "contingency": "B사 장비 교체 검토"},
    {"description": "현장 네트워크 불안정", "level": "MEDIUM", "impact": "데이터 유실 가능", "mitigation": "Edge 서버 로컬 버퍼링 구현", "contingency": "전용선 검토"},
    {"description": "ERP 연동 테스트 환경 접근 지연", "level": "MEDIUM", "impact": "연동 개발 지연", "mitigation": "Mock 서버로 선 개발 후 실환경 테스트", "contingency": "일정 조정"},
    {"description": "iOS 앱 심사 지연", "level": "LOW", "impact": "앱 출시 지연", "mitigation": "사전 심사 가이드라인 준수", "contingency": "Android 선 출시"},
    {"description": "고령 사용자 앱 사용성", "level": "LOW", "impact": "사용자 불만", "mitigation": "큰 글씨, 간단한 UI, SMS 알림 병행", "contingency": "사용자 교육 강화"}
  ],
  "metadata": {
    "version": "1.0",
    "status": "DRAFT",
    "created_at": "2026-01-26T10:00:00",
    "updated_at": null,
    "source_prd_id": "PRD-20260126-100000",
    "source_prd_title": "차량 계량대 시스템 재구축 PRD"
  }
}
