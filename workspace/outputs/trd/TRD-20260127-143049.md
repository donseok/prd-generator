# 부산 스마트 계량 시스템 TRD (Technical Requirements Document)

**버전**: 1.0
**작성일**: 2026-01-27
**기반 PRD**: PRD-20260127-142114
**상태**: Draft

---

## 1. 기술 스택 (Technology Stack)

### 1.1 Frontend (Web)

| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Framework | React | 18.x | PRD 기술 제약 명시, 컴포넌트 기반 UI 개발 용이, 생태계 풍부 |
| State Management | Zustand | 4.x | 경량 상태관리, 러닝커브 낮음, Redux 대비 보일러플레이트 최소화 |
| UI Library | Ant Design | 5.x | 엔터프라이즈 UI 컴포넌트 지원, 테이블(필터/정렬/소계/셀고정) 기능 내장 |
| Chart | Apache ECharts | 5.x | 대시보드 차트, 실시간 데이터 시각화, 한국어 지원 |
| Build Tool | Vite | 5.x | 빠른 빌드 속도, HMR 지원, React 프로젝트 최적화 |
| HTTP Client | Axios | 1.x | REST API 호출, 인터셉터 기반 토큰 관리 |
| Language | TypeScript | 5.x | 타입 안정성, 대규모 프로젝트 유지보수성 향상 |

### 1.2 Frontend (Mobile)

| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Framework | Flutter | 3.x | PRD 기술 제약 명시, iOS/Android 크로스플랫폼 단일 코드베이스 |
| State Management | Riverpod | 2.x | Flutter 공식 권장, 의존성 주입 및 상태관리 통합 |
| HTTP Client | Dio | 5.x | Flutter 표준 HTTP 클라이언트, 인터셉터 지원 |
| Push Notification | Firebase Cloud Messaging | - | iOS/Android 통합 푸시 알림, 무료 |
| Local Storage | Hive | 2.x | 경량 NoSQL, 오프라인 데이터 캐싱 |
| Language | Dart | 3.x | Flutter 공식 언어 |

### 1.3 Backend

| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Language | Java | 17 (LTS) | 장기 지원 버전, 엔터프라이즈 표준 |
| Framework | Spring Boot | 3.2.x | PRD 기술 제약 명시, 엔터프라이즈 표준, 내장 WAS |
| ORM | Spring Data JPA | 3.2.x | 표준 ORM, QueryDSL 연동으로 동적 쿼리 지원 |
| Query | QueryDSL | 5.x | 타입 안전 동적 쿼리, 복잡한 검색/필터 지원 |
| Security | Spring Security | 6.x | 인증/인가 프레임워크, JWT 토큰 기반 인증 |
| API Docs | Springdoc OpenAPI | 2.x | Swagger UI 자동 생성, API 문서화 |
| Validation | Hibernate Validator | 8.x | Bean Validation 구현체, 입력값 검증 |
| Messaging | Apache Kafka | 3.x | 계량 이벤트 비동기 처리, 장비 간 메시지 전달 |

### 1.4 Desktop (C/S)

| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| IDE | Visual Studio 2022 Professional | 17.x | PRD 기술 제약 명시 |
| Language | C# | 11 | .NET 생태계, 시리얼 통신 라이브러리 풍부 |
| Framework | .NET 8 (WinForms) | 8.x | Windows 데스크톱 앱, RS-232C 시리얼 통신 지원 |
| Serial Communication | System.IO.Ports | - | RS-232C 인디게이터 연동 |
| HTTP Client | HttpClient | - | 계량 서버 API 호출 |

### 1.5 Database

| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Primary DB | PostgreSQL | 16.x | PRD 기술 제약 명시, ACID 트랜잭션, JSON 지원, 확장성 |
| Cache | Redis | 7.x | OTP 세션 관리 (TTL 3분), 실시간 계량 상태 캐싱 |
| Connection Pool | HikariCP | 5.x | Spring Boot 기본 커넥션 풀, 고성능 |

### 1.6 AI / LPR

| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| LPR SDK | 외주 LPR 솔루션 | - | 차량번호판 인식 전용 하드웨어 + 소프트웨어 |
| AI 검증 | TensorFlow / ONNX Runtime | - | LPR 인식 결과 2차 검증, OCR 정확도 향상 |
| 통신 | TCP/IP Socket | - | LPR 장비 ↔ 계량 서버 실시간 통신 |

### 1.7 Infrastructure

| 구분 | 기술 | 선정 사유 |
|------|------|----------|
| WAS | Spring Boot Embedded Tomcat | 내장 서버로 별도 WAS 불필요, 배포 단순화 |
| Web Server | Nginx | 리버스 프록시, 정적 파일 서빙, SSL 터미네이션 |
| Container | Docker | 애플리케이션 컨테이너화, 환경 일관성 |
| Orchestration | Docker Compose | 단일 서버 환경 멀티 컨테이너 관리 |
| CI/CD | Jenkins | 사내 CI/CD 파이프라인, 자동 빌드/배포 |
| Monitoring | Prometheus + Grafana | 서버/애플리케이션 메트릭 수집 및 시각화 |
| Log Management | ELK Stack (Elasticsearch + Logstash + Kibana) | 중앙 집중 로그 관리, 장애 분석 |
| Backup | pg_dump + cron | 일일 데이터 백업, 복구 스크립트 |

---

## 2. 시스템 아키텍처 (System Architecture)

### 2.1 전체 아키텍처

```
                              ┌─────────────────────────────────────────────────┐
                              │                 부산공장 계량대                     │
                              │                                                 │
  ┌──────────┐   TCP/IP       │  ┌──────────┐  RS-232C  ┌──────────────────┐   │
  │   LPR    │───────────────▶│  │ 계량대 PC │◄────────▶│   인디게이터      │   │
  │ (카메라)  │                │  │  (C/S)   │           │   (저울)         │   │
  └──────────┘                │  └─────┬────┘           └──────────────────┘   │
                              │        │ TCP/IP                                │
  ┌──────────┐   Serial       │        │          ┌──────────────────┐         │
  │ 레이더    │───────────────▶│        │          │   전광판          │         │
  │ 센서     │                │        ├─────────▶│  (OTP/안내표시)   │         │
  └──────────┘                │        │          └──────────────────┘         │
                              │        │                                       │
  ┌──────────┐   TCP/IP       │        │          ┌──────────────────┐         │
  │ 차량     │───────────────▶│        ├─────────▶│   자동차단기      │         │
  │ 검지기   │                │        │          └──────────────────┘         │
  └──────────┘                │        │                                       │
                              └────────┼───────────────────────────────────────┘
                                       │
                                       ▼ HTTPS
                           ┌───────────────────────┐
                           │       Nginx           │
                           │   (Reverse Proxy)     │
                           └───────────┬───────────┘
                                       │
                          ┌────────────┼────────────┐
                          ▼            ▼            ▼
                   ┌────────────┐ ┌────────┐ ┌──────────┐
                   │ Spring Boot│ │ Kafka  │ │ AI 서버   │
                   │ (REST API) │ │ Broker │ │ (LPR검증) │
                   └──────┬─────┘ └────────┘ └──────────┘
                          │
               ┌──────────┼──────────┐
               ▼          ▼          ▼
        ┌────────────┐ ┌──────┐ ┌────────────┐
        │ PostgreSQL │ │Redis │ │ File Store │
        │ (Primary)  │ │(OTP) │ │ (계량표)    │
        └────────────┘ └──────┘ └────────────┘

  ┌──────────────────┐          ┌──────────────────┐
  │  React Web App   │ HTTPS    │  Flutter Mobile   │ HTTPS
  │  (관리자 웹)      │────────▶│  (계량관리 APP)    │────────▶  Spring Boot API
  └──────────────────┘          └──────────────────┘
                                        │
                                        ▼
                              ┌──────────────────┐
                              │ 카카오 알림톡 API  │
                              │ FCM Push 서버     │
                              └──────────────────┘
```

### 2.2 컴포넌트 설명

| 컴포넌트 | 역할 | 기술 |
|----------|------|------|
| LPR 카메라 | 차량 번호판 촬영 및 1차 인식 | LPR 전용 하드웨어 |
| AI 검증 서버 | LPR 인식 결과 2차 검증 (OCR 보정) | TensorFlow / ONNX Runtime |
| 계량대 C/S 프로그램 | 현장 계량 처리, 장비 연동, OTP 생성 | C# .NET 8 WinForms |
| Spring Boot API 서버 | 비즈니스 로직, REST API 제공 | Java 17, Spring Boot 3.2 |
| Kafka Broker | 계량 이벤트 비동기 처리, Push 알림 트리거 | Apache Kafka 3.x |
| React Web App | 관리자용 웹 대시보드 (배차/계량/출문 관리) | React 18, TypeScript |
| Flutter Mobile App | 운전자/담당자용 모바일 APP | Flutter 3.x, Dart |
| PostgreSQL | 마스터 데이터, 트랜잭션 데이터 저장 | PostgreSQL 16 |
| Redis | OTP 세션 관리 (TTL), 실시간 상태 캐싱 | Redis 7.x |
| Nginx | 리버스 프록시, SSL 터미네이션, 정적 파일 | Nginx |
| 인디게이터 | 중량 측정값 전송 | RS-232C 시리얼 통신 |
| 전광판 | 안내 메시지, OTP 표시 | TCP/IP 프로토콜 |
| 자동차단기 | 차량 진입/출입 통제 | TCP/IP 제어 |
| 레이더센서 | 차량 진입 감지, LPR 촬영 트리거 | 시리얼/TCP 통신 |

### 2.3 통신 방식

| From | To | 프로토콜 | 설명 |
|------|-----|---------|------|
| React Web | Spring Boot API | HTTPS (REST) | 관리 웹 시스템 API 호출 |
| Flutter App | Spring Boot API | HTTPS (REST) | 모바일 APP API 호출 |
| 계량대 C/S | Spring Boot API | HTTPS (REST) | 계량 실적 등록, 배차 정보 조회 |
| 계량대 C/S | 인디게이터 | RS-232C Serial | 중량값 수신 (9600bps, 8N1) |
| 계량대 C/S | 전광판 | TCP/IP Socket | OTP 표시, 안내 메시지 전송 |
| 계량대 C/S | 자동차단기 | TCP/IP Socket | 차단기 개폐 제어 |
| LPR 카메라 | 계량대 C/S | TCP/IP Socket | 차량번호 인식 결과 전송 |
| 레이더센서 | 계량대 C/S | Serial/TCP | 차량 진입 감지 이벤트 |
| Spring Boot | Kafka | TCP | 계량 이벤트 발행 |
| Kafka | Push Service | TCP | 알림 이벤트 소비 |
| Spring Boot | Redis | TCP (6379) | OTP 저장/조회, 세션 캐싱 |
| Spring Boot | PostgreSQL | TCP (5432) | 데이터 CRUD |
| Spring Boot | 카카오 알림톡 | HTTPS | 알림톡 발송 API 호출 |
| Spring Boot | FCM | HTTPS | 모바일 Push 알림 발송 |

---

## 3. 데이터베이스 설계 (Database Design)

### 3.1 엔티티 관계도 (ERD)

```
┌────────────────┐       ┌────────────────┐       ┌────────────────┐
│    company     │       │    vehicle     │       │     driver     │
├────────────────┤       ├────────────────┤       ├────────────────┤
│ id (PK)        │──┐    │ id (PK)        │──┐    │ id (PK)        │
│ name           │  │    │ plate_number   │  │    │ name           │
│ business_no    │  │    │ company_id(FK) │◀─┘    │ phone          │
│ type           │  │    │ vehicle_type   │       │ company_id(FK) │
│ contact        │  │    │ status         │       │ login_id       │
│ created_at     │  │    │ created_at     │       │ password_hash  │
└────────────────┘  │    └────────────────┘       │ role           │
                    │                              │ created_at     │
                    └─────────────────────────────▶└────────────────┘
                                                          │
┌────────────────┐       ┌────────────────┐               │
│    product     │       │   dispatch     │               │
├────────────────┤       ├────────────────┤               │
│ id (PK)        │──┐    │ id (PK)        │◀──────────────┘
│ name           │  │    │ dispatch_no    │
│ category       │  │    │ vehicle_id(FK) │
│ unit           │  │    │ driver_id(FK)  │
│ status         │  └───▶│ product_id(FK) │
│ created_at     │       │ dispatch_type  │
└────────────────┘       │ status         │
                         │ scheduled_date │
                         │ created_at     │
                         └───────┬────────┘
                                 │
                                 ▼
                         ┌────────────────┐       ┌────────────────┐
                         │  weighing      │       │ weighing_slip  │
                         ├────────────────┤       ├────────────────┤
                         │ id (PK)        │──────▶│ id (PK)        │
                         │ dispatch_id(FK)│       │ weighing_id(FK)│
                         │ scale_id(FK)   │       │ slip_no        │
                         │ gross_weight   │       │ slip_data(JSON)│
                         │ tare_weight    │       │ shared_via     │
                         │ net_weight     │       │ shared_at      │
                         │ weighing_type  │       │ created_at     │
                         │ lpr_image_url  │       └────────────────┘
                         │ status         │
                         │ measured_at    │       ┌────────────────┐
                         │ created_at     │       │   otp_log      │
                         └────────────────┘       ├────────────────┤
                                                  │ id (PK)        │
┌────────────────┐       ┌────────────────┐       │ weighing_id(FK)│
│     scale      │       │     user       │       │ otp_code       │
├────────────────┤       ├────────────────┤       │ phone          │
│ id (PK)        │       │ id (PK)        │       │ verified       │
│ scale_name     │       │ login_id       │       │ expires_at     │
│ location       │       │ password_hash  │       │ created_at     │
│ ip_address     │       │ name           │       └────────────────┘
│ port           │       │ role           │
│ status         │       │ department     │       ┌────────────────┐
│ created_at     │       │ phone          │       │ gate_log       │
└────────────────┘       │ created_at     │       ├────────────────┤
                         └────────────────┘       │ id (PK)        │
                                                  │ dispatch_id(FK)│
                                                  │ gate_type      │
                                                  │ passed_at      │
                                                  │ guard_id(FK)   │
                                                  │ created_at     │
                                                  └────────────────┘
```

### 3.2 테이블 명세

#### company (운송사/거래처)

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| name | VARCHAR(100) | NO | - | 업체명 |
| business_no | VARCHAR(20) | YES | - | 사업자번호 |
| type | VARCHAR(20) | NO | - | 업체 유형 (운송사/거래처/기타) |
| contact | VARCHAR(20) | YES | - | 대표 연락처 |
| address | VARCHAR(200) | YES | - | 주소 |
| is_active | BOOLEAN | NO | true | 활성 상태 |
| created_at | TIMESTAMP | NO | now() | 등록일시 |
| updated_at | TIMESTAMP | NO | now() | 수정일시 |

#### vehicle (차량)

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| plate_number | VARCHAR(20) | NO | - | 차량번호 (UNIQUE) |
| company_id | BIGINT | NO | - | FK → company.id |
| vehicle_type | VARCHAR(20) | NO | - | 차량 유형 (덤프/탱크로리/카고 등) |
| tonnage | DECIMAL(10,2) | YES | - | 톤수 |
| tare_weight | DECIMAL(10,2) | YES | - | 공차 중량 (kg) |
| is_active | BOOLEAN | NO | true | 활성 상태 |
| created_at | TIMESTAMP | NO | now() | 등록일시 |
| updated_at | TIMESTAMP | NO | now() | 수정일시 |

#### driver (운전자)

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| name | VARCHAR(50) | NO | - | 운전자명 |
| phone | VARCHAR(20) | NO | - | 전화번호 (UNIQUE, 모바일 인증용) |
| company_id | BIGINT | NO | - | FK → company.id |
| login_id | VARCHAR(50) | YES | - | APP 로그인 ID |
| password_hash | VARCHAR(256) | YES | - | 비밀번호 해시 (bcrypt) |
| role | VARCHAR(20) | NO | 'DRIVER' | 역할 (DRIVER/MANAGER) |
| fcm_token | VARCHAR(256) | YES | - | FCM 푸시 토큰 |
| is_active | BOOLEAN | NO | true | 활성 상태 |
| created_at | TIMESTAMP | NO | now() | 등록일시 |
| updated_at | TIMESTAMP | NO | now() | 수정일시 |

#### product (품목)

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| name | VARCHAR(100) | NO | - | 품목명 |
| category | VARCHAR(20) | NO | - | 분류 (부산물/폐기물/부재료/반출/일반) |
| unit | VARCHAR(10) | NO | 'kg' | 단위 |
| is_active | BOOLEAN | NO | true | 활성 상태 |
| created_at | TIMESTAMP | NO | now() | 등록일시 |

#### dispatch (배차)

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| dispatch_no | VARCHAR(30) | NO | - | 배차번호 (UNIQUE) |
| vehicle_id | BIGINT | NO | - | FK → vehicle.id |
| driver_id | BIGINT | NO | - | FK → driver.id |
| product_id | BIGINT | NO | - | FK → product.id |
| dispatch_type | VARCHAR(20) | NO | - | 배차 유형 (입고/출고) |
| quantity | DECIMAL(10,2) | YES | - | 예정 수량 |
| status | VARCHAR(20) | NO | 'REGISTERED' | 상태 (REGISTERED/IN_PROGRESS/COMPLETED/CANCELLED) |
| scheduled_date | DATE | NO | - | 배차 예정일 |
| notes | TEXT | YES | - | 비고 |
| created_by | BIGINT | YES | - | FK → user.id |
| created_at | TIMESTAMP | NO | now() | 등록일시 |
| updated_at | TIMESTAMP | NO | now() | 수정일시 |

#### scale (계량대)

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| scale_name | VARCHAR(50) | NO | - | 계량대명 |
| location | VARCHAR(100) | NO | - | 설치 위치 |
| ip_address | VARCHAR(15) | YES | - | 계량대 PC IP |
| port | INTEGER | YES | - | 통신 포트 |
| max_capacity | DECIMAL(10,2) | YES | - | 최대 계량 용량 (kg) |
| status | VARCHAR(20) | NO | 'ACTIVE' | 상태 (ACTIVE/MAINTENANCE/INACTIVE) |
| created_at | TIMESTAMP | NO | now() | 등록일시 |

#### weighing (계량)

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| dispatch_id | BIGINT | NO | - | FK → dispatch.id |
| scale_id | BIGINT | NO | - | FK → scale.id |
| weighing_seq | INTEGER | NO | 1 | 계량 차수 (1차/2차/3차) |
| gross_weight | DECIMAL(10,2) | YES | - | 총 중량 (kg) |
| tare_weight | DECIMAL(10,2) | YES | - | 공차 중량 (kg) |
| net_weight | DECIMAL(10,2) | YES | - | 순 중량 (kg) |
| weighing_type | VARCHAR(20) | NO | - | 계량 방식 (LPR_AUTO/MOBILE_OTP/MANUAL/TOUCHSCREEN) |
| lpr_plate_number | VARCHAR(20) | YES | - | LPR 인식 차량번호 |
| lpr_confidence | DECIMAL(5,2) | YES | - | LPR 인식 신뢰도 (%) |
| lpr_image_url | VARCHAR(500) | YES | - | LPR 촬영 이미지 경로 |
| status | VARCHAR(20) | NO | 'WAITING' | 상태 (WAITING/MEASURING/COMPLETED/REWEIGH/CANCELLED) |
| measured_at | TIMESTAMP | YES | - | 계량 완료 시각 |
| created_at | TIMESTAMP | NO | now() | 등록일시 |
| updated_at | TIMESTAMP | NO | now() | 수정일시 |

#### weighing_slip (전자 계량표)

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| weighing_id | BIGINT | NO | - | FK → weighing.id |
| slip_no | VARCHAR(30) | NO | - | 계량표 번호 (UNIQUE) |
| slip_data | JSONB | NO | - | 계량표 상세 데이터 (JSON) |
| pdf_url | VARCHAR(500) | YES | - | PDF 파일 경로 |
| shared_via | VARCHAR(20) | YES | - | 공유 방법 (KAKAO/SMS/NONE) |
| shared_at | TIMESTAMP | YES | - | 공유 시각 |
| created_at | TIMESTAMP | NO | now() | 생성일시 |

#### otp_log (OTP 로그)

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| weighing_id | BIGINT | YES | - | FK → weighing.id |
| otp_code | VARCHAR(6) | NO | - | 6자리 OTP 코드 |
| phone | VARCHAR(20) | NO | - | 인증 대상 전화번호 |
| verified | BOOLEAN | NO | false | 인증 여부 |
| expires_at | TIMESTAMP | NO | - | 만료 시각 (생성 후 3분) |
| verified_at | TIMESTAMP | YES | - | 인증 시각 |
| created_at | TIMESTAMP | NO | now() | 생성일시 |

#### gate_log (출문 기록)

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| dispatch_id | BIGINT | NO | - | FK → dispatch.id |
| gate_type | VARCHAR(20) | NO | - | 출문 유형 (ENTRY/EXIT) |
| passed_at | TIMESTAMP | NO | now() | 통과 시각 |
| guard_id | BIGINT | YES | - | FK → user.id (경비 담당자) |
| notes | TEXT | YES | - | 비고 |
| created_at | TIMESTAMP | NO | now() | 등록일시 |

#### user (시스템 사용자)

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| login_id | VARCHAR(50) | NO | - | 로그인 ID (UNIQUE) |
| password_hash | VARCHAR(256) | NO | - | 비밀번호 해시 (bcrypt) |
| name | VARCHAR(50) | NO | - | 사용자명 |
| role | VARCHAR(20) | NO | - | 역할 (ADMIN/OPERATOR/GUARD/VIEWER) |
| department | VARCHAR(50) | YES | - | 부서 |
| phone | VARCHAR(20) | YES | - | 연락처 |
| is_active | BOOLEAN | NO | true | 활성 상태 |
| last_login_at | TIMESTAMP | YES | - | 마지막 로그인 |
| created_at | TIMESTAMP | NO | now() | 등록일시 |
| updated_at | TIMESTAMP | NO | now() | 수정일시 |

#### notification_log (알림 기록)

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| target_type | VARCHAR(20) | NO | - | 대상 유형 (DRIVER/USER) |
| target_id | BIGINT | NO | - | 대상 ID |
| channel | VARCHAR(20) | NO | - | 채널 (PUSH/KAKAO/SMS) |
| title | VARCHAR(200) | NO | - | 알림 제목 |
| body | TEXT | NO | - | 알림 내용 |
| status | VARCHAR(20) | NO | 'PENDING' | 상태 (PENDING/SENT/FAILED) |
| sent_at | TIMESTAMP | YES | - | 발송 시각 |
| created_at | TIMESTAMP | NO | now() | 생성일시 |

### 3.3 인덱스 전략

| 테이블 | 인덱스명 | 컬럼 | 유형 | 용도 |
|--------|---------|------|------|------|
| vehicle | idx_vehicle_plate | plate_number | UNIQUE B-Tree | 차량번호 검색 (LPR 매칭) |
| driver | idx_driver_phone | phone | UNIQUE B-Tree | 전화번호 기반 OTP 인증 |
| dispatch | idx_dispatch_no | dispatch_no | UNIQUE B-Tree | 배차번호 검색 |
| dispatch | idx_dispatch_date_status | scheduled_date, status | B-Tree | 날짜별 배차 현황 조회 |
| dispatch | idx_dispatch_vehicle | vehicle_id | B-Tree | 차량별 배차 조회 |
| dispatch | idx_dispatch_driver | driver_id | B-Tree | 운전자별 배차 조회 |
| weighing | idx_weighing_dispatch | dispatch_id | B-Tree | 배차별 계량 조회 |
| weighing | idx_weighing_date | measured_at | B-Tree | 날짜별 계량 실적 조회 |
| weighing | idx_weighing_status | status | B-Tree | 상태별 계량 필터링 |
| weighing | idx_weighing_lpr | lpr_plate_number | B-Tree | LPR 인식 번호 검색 |
| weighing_slip | idx_slip_no | slip_no | UNIQUE B-Tree | 계량표 번호 검색 |
| otp_log | idx_otp_code_expires | otp_code, expires_at | B-Tree | OTP 코드 검증 |
| gate_log | idx_gate_dispatch | dispatch_id | B-Tree | 배차별 출문 기록 조회 |
| notification_log | idx_noti_target | target_type, target_id | B-Tree | 대상별 알림 조회 |

---

## 4. API 명세 (API Specification)

### 4.1 공통 사항

- **Base URL**: `/api/v1`
- **인증**: Bearer Token (JWT)
- **응답 형식**: JSON
- **공통 응답 구조**:

```json
{
  "success": true,
  "data": { ... },
  "message": "요청이 성공적으로 처리되었습니다.",
  "timestamp": "2026-01-27T14:00:00+09:00"
}
```

- **에러 응답 구조**:

```json
{
  "success": false,
  "error": {
    "code": "ERR_001",
    "message": "에러 메시지"
  },
  "timestamp": "2026-01-27T14:00:00+09:00"
}
```

### 4.2 인증 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| POST | /auth/login | 웹 사용자 로그인 | - |
| POST | /auth/mobile/login | 모바일 APP 로그인 | - |
| POST | /auth/mobile/verify | 인증번호 확인 | - |
| POST | /auth/refresh | 토큰 갱신 | Required |
| POST | /auth/logout | 로그아웃 | Required |

### 4.3 배차 관리 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | /dispatches | 배차 목록 조회 | Required |
| GET | /dispatches/{id} | 배차 상세 조회 | Required |
| POST | /dispatches | 배차 등록 | Required (ADMIN/OPERATOR) |
| PUT | /dispatches/{id} | 배차 수정 | Required (ADMIN/OPERATOR) |
| DELETE | /dispatches/{id} | 배차 삭제 | Required (ADMIN) |
| GET | /dispatches/driver/{driverId} | 운전자별 배차 조회 | Required |
| PUT | /dispatches/{id}/status | 배차 상태 변경 | Required |

### 4.4 계량 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | /weighings | 계량 실적 목록 조회 | Required |
| GET | /weighings/{id} | 계량 상세 조회 | Required |
| POST | /weighings | 계량 등록 (C/S → 서버) | Required |
| PUT | /weighings/{id} | 계량 수정 | Required |
| POST | /weighings/{id}/reweigh | 재계량 요청 | Required |
| GET | /weighings/stats | 계량 통계 조회 | Required |
| GET | /weighings/realtime | 실시간 계량 현황 | Required |

### 4.5 OTP API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| POST | /otp/generate | OTP 생성 (계량대 → 서버) | Required |
| POST | /otp/verify | OTP 검증 (모바일 → 서버) | Required |

### 4.6 계량표 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | /slips | 계량표 목록 조회 | Required |
| GET | /slips/{id} | 계량표 상세 조회 | Required |
| GET | /slips/{id}/pdf | 계량표 PDF 다운로드 | Required |
| POST | /slips/{id}/share | 계량표 공유 (카카오톡/SMS) | Required |

### 4.7 기준정보 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | /companies | 업체 목록 조회 | Required |
| POST | /companies | 업체 등록 | Required (ADMIN) |
| PUT | /companies/{id} | 업체 수정 | Required (ADMIN) |
| GET | /vehicles | 차량 목록 조회 | Required |
| POST | /vehicles | 차량 등록 | Required (ADMIN) |
| PUT | /vehicles/{id} | 차량 수정 | Required (ADMIN) |
| GET | /drivers | 운전자 목록 조회 | Required |
| POST | /drivers | 운전자 등록 | Required (ADMIN) |
| PUT | /drivers/{id} | 운전자 수정 | Required (ADMIN) |
| GET | /products | 품목 목록 조회 | Required |
| POST | /products | 품목 등록 | Required (ADMIN) |
| GET | /scales | 계량대 목록 조회 | Required |

### 4.8 출문 관리 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | /gates | 출문 기록 목록 조회 | Required |
| POST | /gates | 출문 기록 등록 | Required |
| GET | /gates/check/{dispatchId} | 배차별 출문 확인 | Required |

### 4.9 알림 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| POST | /notifications/push | Push 알림 발송 | Internal |
| POST | /notifications/kakao | 카카오 알림톡 발송 | Internal |
| GET | /notifications | 알림 이력 조회 | Required |

### 4.10 대시보드 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | /dashboard/summary | 대시보드 요약 | Required |
| GET | /dashboard/weighing-chart | 계량 추이 차트 | Required |
| GET | /dashboard/dispatch-status | 배차 현황 | Required |

---

## 5. 보안 요구사항 (Security Requirements)

### 5.1 인증/인가

| 항목 | 구현 방식 |
|------|----------|
| 웹 인증 | JWT (Access Token 30분 + Refresh Token 7일) |
| 모바일 인증 | JWT + 인증번호(SMS) 2차 인증 |
| OTP 인증 | 6자리 난수 OTP, Redis TTL 3분, 1회 사용 후 폐기 |
| 권한 관리 | RBAC (ADMIN, OPERATOR, GUARD, VIEWER, DRIVER, MANAGER) |
| 세션 관리 | Stateless JWT, Redis 블랙리스트 (로그아웃 토큰) |

### 5.2 데이터 보안

| 항목 | 구현 방식 |
|------|----------|
| 전송 암호화 | TLS 1.3 (Nginx SSL 터미네이션) |
| 저장 암호화 | AES-256 (전화번호, 사업자번호 등 개인정보) |
| 비밀번호 | bcrypt (cost factor 12) |
| API Key | 장비 간 통신 시 API Key 기반 인증 |
| 데이터 마스킹 | 전화번호/차량번호 로그 출력 시 마스킹 |

### 5.3 보안 정책

- [x] OWASP Top 10 대응
- [x] SQL Injection 방지 (JPA Parameterized Query)
- [x] XSS 방지 (React 자동 이스케이프 + Content Security Policy)
- [x] CSRF 방지 (SameSite Cookie + CSRF Token)
- [x] Rate Limiting (OTP 요청: 1분 3회, API 일반: 분당 100회)
- [x] CORS 설정 (허용 도메인 화이트리스트)
- [x] Security Headers (X-Frame-Options, X-Content-Type-Options, Strict-Transport-Security)
- [x] 접근 로그 기록 (사용자 행위 감사 추적)

---

## 6. 성능 요구사항 (Performance Requirements)

### 6.1 응답 시간

| 구분 | 목표값 | 측정 방법 |
|------|--------|----------|
| LPR 차량번호 인식 | < 2초 | LPR 장비 → 계량대 C/S 수신 |
| AI 검증 | < 1초 | AI 서버 API 응답시간 |
| REST API 응답 (p50) | < 200ms | Spring Boot Actuator |
| REST API 응답 (p95) | < 500ms | Spring Boot Actuator |
| 웹 페이지 로딩 | < 3초 | Chrome Lighthouse |
| 모바일 APP 응답 | < 2초 | Flutter DevTools |
| OTP 생성/검증 | < 100ms | Redis 응답시간 |

### 6.2 처리량

| 구분 | 목표값 |
|------|--------|
| 동시 접속자 (웹) | 50명 |
| 동시 접속자 (모바일) | 100명 |
| 일일 계량 처리 건수 | 500건 이상 |
| TPS (Transactions Per Second) | 50 TPS |

### 6.3 최적화 전략

- [x] DB Connection Pooling (HikariCP, min 10 / max 30)
- [x] Redis 캐싱 (기준정보, 자주 조회 데이터 TTL 5분)
- [x] Query Optimization (QueryDSL, N+1 문제 방지, Fetch Join)
- [x] 인덱스 최적화 (검색 빈도 높은 컬럼 인덱스)
- [x] API 페이징 (기본 20건, 최대 100건)
- [x] 이미지 압축 (LPR 촬영 이미지 리사이즈 저장)
- [x] 웹 정적 리소스 Gzip 압축 + 브라우저 캐싱
- [x] Lazy Loading (대시보드 차트 컴포넌트)

---

## 7. 인프라 요구사항 (Infrastructure Requirements)

### 7.1 서버 구성

| 환경 | 구성 | 스펙 |
|------|------|------|
| Development | 개발 서버 1대 | CPU 4Core, RAM 16GB, SSD 256GB |
| Staging | 스테이징 서버 1대 | CPU 4Core, RAM 16GB, SSD 256GB |
| Production - WEB/WAS | 애플리케이션 서버 1대 | CPU 8Core, RAM 32GB, SSD 512GB |
| Production - DB | 데이터베이스 서버 1대 | CPU 8Core, RAM 32GB, SSD 1TB |
| Production - File | 파일 서버 (LPR 이미지) | SSD 500GB |
| 계량대 PC | 현장 계량대 PC 1대 | 기존 장비 사용, Windows 10 |

### 7.2 네트워크 구성

```
인터넷 ─── 방화벽 ─── DMZ (Nginx) ─── 내부망 (App/DB 서버)
                                          │
                                     계량대 네트워크
                                     (LPR/전광판/차단기)
```

- 외부 접속: Nginx (443 port) → Spring Boot (8080)
- 내부 장비: 사내 네트워크 (VPN 또는 전용선)
- 모바일 APP: 인터넷 경유 HTTPS 접속

### 7.3 배포 전략

- **배포 방식**: Rolling Update (Docker Compose)
- **배포 절차**: Jenkins → Docker Build → Docker Compose Up
- **롤백 전략**: 이전 Docker 이미지 태그로 재배포
- **배포 환경**: dev → staging → production 순차 배포

### 7.4 모니터링

| 대상 | 도구 | 알림 조건 |
|------|------|----------|
| Application | Prometheus + Grafana | API 응답시간 p95 > 1초, 에러율 > 1% |
| Database | pgAdmin + Prometheus Exporter | 커넥션 풀 사용률 > 80%, 슬로우 쿼리 > 3초 |
| Server | Grafana (Node Exporter) | CPU > 80%, Memory > 85%, Disk > 90% |
| Log | ELK Stack | ERROR 레벨 로그 발생, 계량 실패 이벤트 |
| LPR | 자체 모니터링 | LPR 인식 실패율 > 10%, 장비 통신 단절 |
| Uptime | Prometheus Blackbox | 서비스 다운 감지 (1분 간격 Health Check) |

### 7.5 백업/복구

| 항목 | 방법 | 주기 | 보관기간 |
|------|------|------|----------|
| DB 전체 백업 | pg_dump (전체) | 일 1회 (02:00) | 30일 |
| DB 증분 백업 | WAL 아카이빙 | 실시간 | 7일 |
| LPR 이미지 | 파일 복사 | 일 1회 | 90일 |
| 애플리케이션 설정 | Git 저장소 | 변경 시 | 영구 |

---

## 8. 기술 리스크 (Technical Risks)

| ID | 리스크 | 영향도 | 발생 가능성 | 대응 방안 |
|----|--------|--------|------------|----------|
| TR-001 | LPR 인식률 저하 (야간, 우천, 오염) | HIGH | MEDIUM | AI 2차 검증 + 모바일 OTP 대체 경로, 보조 조명 설치 검토 |
| TR-002 | 계량대 네트워크 단절 | HIGH | LOW | 계량대 C/S 오프라인 모드 (로컬 저장 후 재전송), 기존 터치스크린 Failover |
| TR-003 | 모바일 APP 배포 지연 (앱스토어 심사) | MEDIUM | MEDIUM | 사전 심사 일정 확보 (2주), 긴급 시 웹뷰 대체 방안 |
| TR-004 | RS-232C 장비 호환성 | MEDIUM | LOW | 사전 프로토콜 분석, 기존 동작 장비 재사용, 테스트 기간 확보 |
| TR-005 | 카카오 알림톡 API 변경/장애 | LOW | LOW | SMS 대체 발송 로직, 재시도 큐(Kafka DLQ) |
| TR-006 | 동시 계량 시 데이터 정합성 | HIGH | LOW | DB 트랜잭션 격리 수준 READ COMMITTED, 낙관적 잠금(Optimistic Lock) |
| TR-007 | AI 모델 정확도 미달 | MEDIUM | MEDIUM | 부산공장 환경 데이터로 Fine-tuning, 인식 실패 시 자동 OTP 전환 |
| TR-008 | 기존 시스템 데이터 마이그레이션 | MEDIUM | MEDIUM | 단계별 마이그레이션, 병행 운영 기간 확보, 롤백 시나리오 준비 |

---

## 9. 참고 문서

- **기반 PRD**: `workspace/outputs/prd/PRD-20260127-142114.md`
- **원본 자료**: 부산 스마트 계량 시스템 구축 - 수행계획서.pptx
- **기술 참고**: Spring Boot 3.2 공식 문서, Flutter 3.x 공식 문서, PostgreSQL 16 공식 문서

---

*이 문서는 TRD 자동 생성 시스템에 의해 작성되었습니다.*
