# 차량 계량대 시스템 재구축 TRD (Technical Requirements Document)

**버전**: 1.0
**작성일**: 2026-01-25
**기반 PRD**: PRD-20260125-143000
**상태**: Draft

---

## 1. 기술 스택 (Technology Stack)

### 1.1 Frontend (웹)
| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Framework | React | 18.x | 컴포넌트 기반 개발, 풍부한 생태계, 실시간 데이터 갱신에 적합 |
| State Management | Zustand | 4.x | 간결한 API, 작은 번들 사이즈, Redux 대비 낮은 러닝커브 |
| UI Library | Ant Design | 5.x | 관리자용 대시보드에 최적화된 컴포넌트, 한국어 지원 |
| Charting | Recharts | 2.x | React 친화적, 막대/라인 차트 시각화 지원 |
| Build Tool | Vite | 5.x | 빠른 HMR, 최적화된 빌드 성능 |
| HTTP Client | Axios | 1.x | 인터셉터, 요청 취소, 자동 재시도 기능 |
| WebSocket | Socket.io-client | 4.x | 실시간 데이터 갱신, 자동 재연결 지원 |

### 1.2 Frontend (모바일)
| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Framework | Flutter | 3.x | iOS/Android 크로스 플랫폼, 네이티브 수준 성능 |
| State Management | Riverpod | 2.x | 타입 안전성, 의존성 주입 지원 |
| Push Notification | Firebase Messaging | Latest | FCM 기반 iOS/Android 통합 푸시 |
| Local Storage | Hive | 2.x | 경량 NoSQL, 오프라인 데이터 캐싱 |
| HTTP Client | Dio | 5.x | 인터셉터, 재시도, 파일 다운로드 지원 |

### 1.3 Backend
| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Language | Python | 3.11 | 개발 생산성, 풍부한 라이브러리, PRD 명시 |
| Framework | FastAPI | 0.109 | 비동기 지원, 자동 OpenAPI 문서화, 높은 성능 |
| ORM | SQLAlchemy | 2.x | 타입 힌트 지원, 비동기 쿼리 지원 |
| Migration | Alembic | 1.x | SQLAlchemy 호환, 버전 관리 마이그레이션 |
| Task Queue | Celery | 5.x | 배치 작업, ERP 마감 전송, 리포트 생성 |
| Message Broker | Redis | 7.x | Celery 브로커, 세션 캐싱, pub/sub |
| WebSocket | Socket.io | 5.x | 실시간 양방향 통신, 자동 재연결 |

### 1.4 Edge Server
| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Language | Python | 3.11 | 백엔드와 동일 기술 스택, 유지보수 용이 |
| Serial Communication | pyserial | 3.x | RS-232 시리얼 통신 표준 라이브러리 |
| Local DB | SQLite | 3.x | 경량, 네트워크 단절 시 로컬 버퍼링 |
| HTTP Client | httpx | 0.27 | 비동기 HTTP 클라이언트 |
| Process Manager | Supervisor | 4.x | 프로세스 자동 재시작, 로그 관리 |

### 1.5 Database
| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Primary DB | PostgreSQL (RDS) | 15.x | ACID 보장, Multi-AZ 지원, JSON 타입 지원 |
| Cache | Redis (ElastiCache) | 7.x | 세션 관리, 실시간 데이터 캐싱, pub/sub |
| Search | PostgreSQL Full-Text | 15.x | 별도 검색 엔진 불필요, 차량번호/기사명 검색 충분 |

### 1.6 Infrastructure
| 구분 | 기술 | 선정 사유 |
|------|------|----------|
| Cloud Provider | AWS | 국내 리전(서울) 지원, Multi-AZ, Auto Scaling |
| Container | Docker | 환경 일관성, 배포 자동화 |
| Orchestration | ECS Fargate | 서버리스 컨테이너, 관리 오버헤드 최소화 |
| Load Balancer | ALB | HTTPS 종료, WebSocket 지원, 헬스체크 |
| CI/CD | GitHub Actions | 코드 저장소 통합, 비용 효율적 |
| Monitoring | CloudWatch + Grafana | AWS 네이티브 메트릭 + 커스텀 대시보드 |
| APM | AWS X-Ray | 분산 트레이싱, 성능 병목 분석 |
| Log Management | CloudWatch Logs | 중앙화된 로그 관리, 알람 연동 |

---

## 2. 시스템 아키텍처 (System Architecture)

### 2.1 전체 아키텍처

```
                                    ┌─────────────────────────────────────────────────────────────────┐
                                    │                         AWS Cloud                               │
                                    │  ┌─────────────────────────────────────────────────────────┐   │
                                    │  │                      VPC (10.0.0.0/16)                   │   │
┌──────────────┐                    │  │                                                          │   │
│   웹 브라우저   │──HTTPS──┐         │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │   │
│   (관리자)     │         │         │  │  │   ALB       │───▶│  ECS Fargate │───▶│   RDS       │  │   │
└──────────────┘         │         │  │  │  (HTTPS)    │    │  (FastAPI)  │    │ (PostgreSQL)│  │   │
                          │         │  │  └─────────────┘    └──────┬──────┘    └─────────────┘  │   │
┌──────────────┐         │         │  │         ▲                   │                            │   │
│   모바일 앱    │──HTTPS──┼─────────┼──┼─────────┤                   ▼                            │   │
│   (운전기사)   │         │         │  │         │           ┌─────────────┐                     │   │
└──────────────┘         │         │  │         │           │ ElastiCache │                     │   │
                          │         │  │         │           │   (Redis)   │                     │   │
                          ▼         │  │         │           └─────────────┘                     │   │
                    ┌───────────┐   │  │         │                                                │   │
                    │ CloudFront│   │  │    WebSocket                                             │   │
                    │   (CDN)   │───┼──┼─────────┘                                                │   │
                    └───────────┘   │  │                                                          │   │
                                    │  │  ┌─────────────┐         ┌─────────────┐                 │   │
                                    │  │  │   S3       │         │ CloudWatch  │                 │   │
                                    │  │  │ (정적 파일) │         │ (모니터링)   │                 │   │
                                    │  │  └─────────────┘         └─────────────┘                 │   │
                                    │  └──────────────────────────────────────────────────────────┘   │
                                    └─────────────────────────────────────────────────────────────────┘
                                                          ▲
                                                          │ HTTPS (API)
                                                          │
                    ┌─────────────────────────────────────┼─────────────────────────────────────┐
                    │                           현장 네트워크                                     │
                    │                                     │                                      │
                    │  ┌─────────────┐           ┌────────┴────────┐                            │
                    │  │  전광판      │◀──TCP────│   Edge Server    │                            │
                    │  │  (TCP/IP)   │           │    (Python)     │                            │
                    │  └─────────────┘           └────────┬────────┘                            │
                    │                                     │                                      │
                    │              ┌──────────────────────┼──────────────────────┐              │
                    │              │                      │                      │              │
                    │              ▼                      ▼                      ▼              │
                    │       ┌───────────┐          ┌───────────┐          ┌───────────┐        │
                    │       │인디케이터 A1│          │인디케이터 A2│          │인디케이터 B │        │
                    │       │  (RS-232) │          │  (RS-232) │          │  (RS-232) │        │
                    │       └───────────┘          └───────────┘          └───────────┘        │
                    │                                                                           │
                    └───────────────────────────────────────────────────────────────────────────┘

                                                          │
                                              VPN / 전용선 (IP Whitelist)
                                                          │
                                                          ▼
                                                  ┌───────────────┐
                                                  │   ERP 시스템   │
                                                  │ (REST API)    │
                                                  └───────────────┘
```

### 2.2 컴포넌트 설명
| 컴포넌트 | 역할 | 기술 |
|----------|------|------|
| ALB | HTTPS 종료, 라우팅, 헬스체크, WebSocket 지원 | AWS Application Load Balancer |
| ECS Fargate | 컨테이너 기반 API 서버, Auto Scaling | Docker, FastAPI |
| RDS | 계량 데이터, 차량/기사 정보 저장 | PostgreSQL 15, Multi-AZ |
| ElastiCache | 세션 캐시, 실시간 대기열, pub/sub | Redis 7 |
| S3 | 정적 파일, 전표 이미지, 리포트 파일 저장 | AWS S3 |
| CloudFront | 정적 자원 CDN, 글로벌 엣지 캐싱 | AWS CloudFront |
| Edge Server | 인디케이터 데이터 수집, 로컬 버퍼링, 전광판 제어 | Python, pyserial |
| CloudWatch | 메트릭 수집, 로그 관리, 알람 | AWS CloudWatch |

### 2.3 통신 방식
| From | To | 프로토콜 | 포트 | 설명 |
|------|-----|---------|------|------|
| 웹/앱 클라이언트 | ALB | HTTPS | 443 | REST API, WebSocket 통신 |
| ALB | ECS | HTTP | 8000 | 내부 API 서버 통신 |
| ECS | RDS | TCP | 5432 | PostgreSQL 연결 |
| ECS | ElastiCache | TCP | 6379 | Redis 캐시 연결 |
| Edge Server | ECS | HTTPS | 443 | 계량 데이터 전송 |
| Edge Server | 인디케이터 | RS-232 | - | 시리얼 통신 (9600bps) |
| Edge Server | 전광판 | TCP | 5000 | 순번 표시 데이터 |
| ECS | ERP | HTTPS | 443 | OAuth 2.0 인증 REST API |

---

## 3. 데이터베이스 설계 (Database Design)

### 3.1 엔티티 관계도 (ERD)

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│     Company     │       │     Vehicle     │       │     Driver      │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │       │ id (PK)         │       │ id (PK)         │
│ name            │◀──┐   │ plate_number    │──┐    │ name            │
│ business_no     │   │   │ vehicle_type    │  │    │ phone (암호화)   │
│ contact         │   │   │ tare_weight     │  │    │ company_id (FK) │──┐
│ created_at      │   │   │ max_load        │  │    │ app_user_id     │  │
│ is_active       │   └───│ company_id (FK) │  │    │ is_active       │  │
└─────────────────┘       │ is_active       │  │    │ created_at      │  │
                          │ created_at      │  │    └─────────────────┘  │
                          └─────────────────┘  │              │           │
                                    │          │              │           │
                                    │          │              ▼           │
┌─────────────────┐                 │          │    ┌─────────────────┐  │
│  WeighStation   │                 │          │    │  VehicleDriver  │  │
├─────────────────┤                 │          │    ├─────────────────┤  │
│ id (PK)         │                 │          │    │ id (PK)         │  │
│ name            │                 │          └───▶│ vehicle_id (FK) │  │
│ indicator_type  │                 │               │ driver_id (FK)  │◀─┘
│ protocol        │                 │               │ is_primary      │
│ ip_address      │                 │               │ created_at      │
│ port            │                 │               └─────────────────┘
│ status          │                 │
│ last_heartbeat  │                 │
└─────────────────┘                 │
        │                           │
        │                           │
        ▼                           ▼
┌─────────────────────────────────────────────────┐
│                   WeighRecord                    │
├─────────────────────────────────────────────────┤
│ id (PK)                                          │
│ station_id (FK) ─────────────────────────────────│
│ vehicle_id (FK) ─────────────────────────────────│
│ driver_id (FK)                                   │
│ gross_weight (총중량, kg)                         │
│ tare_weight (공차중량, kg)                        │
│ net_weight (순중량, kg)                           │
│ slip_number (전표번호)                            │
│ weighed_at (계량일시)                             │
│ status (대기/계량중/완료)                          │
│ erp_sent (ERP 전송 여부)                          │
│ erp_sent_at                                      │
│ created_at                                       │
└─────────────────────────────────────────────────┘
        │
        │
        ▼
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   WaitQueue     │       │   Notification  │       │    AppUser      │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │       │ id (PK)         │       │ id (PK)         │
│ driver_id (FK)  │       │ driver_id (FK)  │       │ login_id        │
│ vehicle_id (FK) │       │ type            │       │ password_hash   │
│ queue_number    │       │ title           │       │ role            │
│ station_id (FK) │       │ message         │       │ driver_id (FK)  │
│ status          │       │ is_read         │       │ fcm_token       │
│ estimated_time  │       │ sent_at         │       │ last_login_at   │
│ called_at       │       │ created_at      │       │ is_active       │
│ created_at      │       └─────────────────┘       │ created_at      │
└─────────────────┘                                 └─────────────────┘
```

### 3.2 테이블 명세

#### Company (소속회사)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| name | VARCHAR(100) | NO | - | 회사명 |
| business_no | VARCHAR(20) | YES | - | 사업자등록번호 |
| contact | VARCHAR(50) | YES | - | 연락처 |
| address | VARCHAR(200) | YES | - | 주소 |
| is_active | BOOLEAN | NO | TRUE | 활성 여부 |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 수정일시 |

#### Vehicle (차량)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| plate_number | VARCHAR(20) | NO | - | 차량번호 (UNIQUE) |
| vehicle_type | VARCHAR(50) | YES | - | 차종 |
| tare_weight | DECIMAL(10,2) | YES | - | 공차중량 (kg) |
| max_load | DECIMAL(10,2) | YES | - | 최대적재량 (kg) |
| company_id | BIGINT | YES | - | 소속회사 FK |
| is_active | BOOLEAN | NO | TRUE | 활성 여부 |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 수정일시 |

#### Driver (운전기사)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| name | VARCHAR(50) | NO | - | 기사명 |
| phone | BYTEA | NO | - | 연락처 (AES-256 암호화) |
| company_id | BIGINT | YES | - | 소속회사 FK |
| app_user_id | BIGINT | YES | - | 앱 계정 FK |
| is_active | BOOLEAN | NO | TRUE | 활성 여부 |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 수정일시 |

#### WeighStation (계량대)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| name | VARCHAR(50) | NO | - | 계량대명 |
| indicator_type | VARCHAR(20) | NO | - | 제조사 (A/B) |
| protocol | VARCHAR(100) | YES | - | 통신 프로토콜 정보 |
| serial_port | VARCHAR(20) | YES | - | 시리얼 포트 (COM1 등) |
| status | VARCHAR(20) | NO | 'IDLE' | 상태 (IDLE/WEIGHING/ERROR) |
| last_heartbeat | TIMESTAMPTZ | YES | - | 마지막 연결 확인 시각 |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |

#### WeighRecord (계량 기록)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| station_id | BIGINT | NO | - | 계량대 FK |
| vehicle_id | BIGINT | NO | - | 차량 FK |
| driver_id | BIGINT | YES | - | 운전기사 FK |
| gross_weight | DECIMAL(10,2) | YES | - | 총중량 (kg) |
| tare_weight | DECIMAL(10,2) | YES | - | 공차중량 (kg) |
| net_weight | DECIMAL(10,2) | YES | - | 순중량 (kg) |
| slip_number | VARCHAR(20) | NO | - | 전표번호 (UNIQUE) |
| weighed_at | TIMESTAMPTZ | NO | NOW() | 계량일시 |
| status | VARCHAR(20) | NO | 'PENDING' | 상태 (PENDING/WEIGHING/COMPLETED) |
| erp_sent | BOOLEAN | NO | FALSE | ERP 전송 여부 |
| erp_sent_at | TIMESTAMPTZ | YES | - | ERP 전송 일시 |
| erp_response | JSONB | YES | - | ERP 응답 데이터 |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 수정일시 |

#### WaitQueue (대기열)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| driver_id | BIGINT | NO | - | 운전기사 FK |
| vehicle_id | BIGINT | NO | - | 차량 FK |
| station_id | BIGINT | YES | - | 배정 계량대 FK |
| queue_number | INTEGER | NO | - | 대기 순번 |
| status | VARCHAR(20) | NO | 'WAITING' | 상태 (WAITING/CALLED/COMPLETED/CANCELLED) |
| estimated_time | INTEGER | YES | - | 예상 대기시간 (분) |
| called_at | TIMESTAMPTZ | YES | - | 호출 시각 |
| completed_at | TIMESTAMPTZ | YES | - | 완료 시각 |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |

#### AppUser (앱 사용자)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| id | BIGSERIAL | NO | AUTO | Primary Key |
| login_id | VARCHAR(50) | NO | - | 로그인 ID (UNIQUE) |
| password_hash | VARCHAR(255) | NO | - | 비밀번호 해시 (bcrypt) |
| role | VARCHAR(20) | NO | 'DRIVER' | 역할 (ADMIN/STAFF/DRIVER) |
| driver_id | BIGINT | YES | - | 운전기사 FK |
| fcm_token | VARCHAR(255) | YES | - | FCM 토큰 |
| refresh_token | VARCHAR(255) | YES | - | Refresh Token |
| last_login_at | TIMESTAMPTZ | YES | - | 마지막 로그인 |
| is_active | BOOLEAN | NO | TRUE | 활성 여부 |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 수정일시 |

### 3.3 인덱스 전략
| 테이블 | 인덱스명 | 컬럼 | 유형 | 용도 |
|--------|---------|------|------|------|
| vehicle | idx_vehicle_plate | plate_number | B-Tree | 차량번호 검색 |
| driver | idx_driver_name | name | B-Tree | 기사명 검색 |
| driver | idx_driver_company | company_id | B-Tree | 회사별 기사 조회 |
| weigh_record | idx_record_date | weighed_at | B-Tree | 날짜별 조회 |
| weigh_record | idx_record_vehicle | vehicle_id | B-Tree | 차량별 이력 조회 |
| weigh_record | idx_record_slip | slip_number | B-Tree | 전표번호 검색 |
| weigh_record | idx_record_erp | erp_sent, weighed_at | B-Tree | ERP 미전송 데이터 조회 |
| wait_queue | idx_queue_status | status, created_at | B-Tree | 대기열 조회 |
| app_user | idx_user_login | login_id | B-Tree | 로그인 조회 |

---

## 4. API 명세 (API Specification)

### 4.1 공통 사항
- Base URL: `/api/v1`
- 인증: Bearer Token (JWT)
- Access Token 만료: 1시간
- Refresh Token 만료: 7일
- 응답 형식: JSON
- 에러 응답 형식:
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "에러 메시지"
  }
}
```

### 4.2 인증 API

#### POST /auth/login
**설명**: 로그인

**Request**:
```json
{
  "login_id": "string",
  "password": "string"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "access_token": "eyJhbGc...",
    "refresh_token": "eyJhbGc...",
    "expires_in": 3600,
    "user": {
      "id": 1,
      "login_id": "driver001",
      "role": "DRIVER",
      "name": "홍길동"
    }
  }
}
```

#### POST /auth/refresh
**설명**: 토큰 갱신

**Request**:
```json
{
  "refresh_token": "eyJhbGc..."
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "access_token": "eyJhbGc...",
    "expires_in": 3600
  }
}
```

### 4.3 대시보드 API

#### GET /dashboard/realtime
**설명**: 실시간 대시보드 데이터

**Request Headers**: `Authorization: Bearer {token}`

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "stations": [
      {
        "id": 1,
        "name": "1번 계량대",
        "status": "WEIGHING",
        "current_vehicle": "12가3456",
        "last_weight": 15000.5
      }
    ],
    "today_summary": {
      "total_count": 45,
      "completed_count": 42,
      "avg_process_time": 180
    },
    "wait_queue": [
      {
        "queue_number": 1,
        "vehicle_plate": "34나5678",
        "driver_name": "김철수",
        "estimated_time": 5
      }
    ],
    "hourly_stats": [
      {"hour": 8, "count": 5},
      {"hour": 9, "count": 12}
    ]
  }
}
```

### 4.4 계량 기록 API

#### GET /weigh-records
**설명**: 계량 이력 조회

**Request Headers**: `Authorization: Bearer {token}`

**Query Parameters**:
- `start_date` (required): 시작일 (YYYY-MM-DD)
- `end_date` (required): 종료일 (YYYY-MM-DD)
- `vehicle_plate` (optional): 차량번호
- `driver_name` (optional): 운전기사명
- `page` (optional, default: 1): 페이지 번호
- `limit` (optional, default: 20): 페이지당 항목 수

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "slip_number": "WR20260125001",
        "vehicle_plate": "12가3456",
        "driver_name": "홍길동",
        "gross_weight": 25000.0,
        "tare_weight": 10000.0,
        "net_weight": 15000.0,
        "weighed_at": "2026-01-25T14:30:00+09:00",
        "station_name": "1번 계량대"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 150,
      "total_pages": 8
    }
  }
}
```

#### GET /weigh-records/export
**설명**: 계량 데이터 엑셀 내보내기

**Query Parameters**: (동일)

**Response**: Excel 파일 다운로드 (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)

### 4.5 차량 API

#### GET /vehicles
**설명**: 차량 목록 조회

#### POST /vehicles
**설명**: 차량 등록

**Request**:
```json
{
  "plate_number": "12가3456",
  "vehicle_type": "덤프트럭",
  "tare_weight": 10000.0,
  "max_load": 20000.0,
  "company_id": 1
}
```

#### PUT /vehicles/{id}
**설명**: 차량 정보 수정

#### DELETE /vehicles/{id}
**설명**: 차량 비활성화

### 4.6 운전기사 API

#### GET /drivers
**설명**: 운전기사 목록 조회

#### POST /drivers
**설명**: 운전기사 등록 및 앱 계정 자동 생성

**Request**:
```json
{
  "name": "홍길동",
  "phone": "010-1234-5678",
  "company_id": 1,
  "vehicle_ids": [1, 2]
}
```

**Response** (201 Created):
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "홍길동",
    "app_account": {
      "login_id": "driver_hong123",
      "temporary_password": "Ab12#456"
    },
    "sms_sent": true
  }
}
```

### 4.7 모바일 앱 API

#### GET /mobile/queue/my
**설명**: 내 대기 순번 조회

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "queue_number": 5,
    "ahead_count": 4,
    "estimated_wait_time": 12,
    "status": "WAITING"
  }
}
```

#### GET /mobile/records/today
**설명**: 금일 계량 결과 조회

#### GET /mobile/records/history
**설명**: 최근 30일 계량 이력

#### GET /mobile/slip/{id}
**설명**: 전자 전표 조회

#### POST /mobile/slip/{id}/share
**설명**: 전표 공유 (이메일/카카오톡)

**Request**:
```json
{
  "method": "kakao|email|sms",
  "recipient": "string"
}
```

### 4.8 Edge Server API (내부용)

#### POST /internal/weigh-data
**설명**: 인디케이터 계량 데이터 수신

**Request Headers**: `X-API-Key: {edge_server_api_key}`

**Request**:
```json
{
  "station_id": 1,
  "weight": 25000.5,
  "unit": "KG",
  "stable": true,
  "timestamp": "2026-01-25T14:30:00+09:00"
}
```

### 4.9 통계 API

#### GET /statistics/daily
**설명**: 일간 통계

#### GET /statistics/weekly
**설명**: 주간 통계 (전주 대비)

#### GET /statistics/monthly
**설명**: 월간 통계 (전월 대비, 추세)

#### GET /statistics/export
**설명**: 통계 리포트 다운로드 (PDF/Excel)

---

## 5. 보안 요구사항 (Security Requirements)

### 5.1 인증/인가
| 항목 | 구현 방식 |
|------|----------|
| 인증 | JWT (Access Token 1시간 + Refresh Token 7일) |
| 권한 관리 | RBAC (ADMIN, STAFF, DRIVER) |
| 비밀번호 정책 | 최소 8자, 영문+숫자+특수문자 조합 |
| 비밀번호 저장 | bcrypt (cost factor 12) |
| 세션 관리 | Redis 기반, 동시 로그인 제한 (3대) |
| 생체 인증 | 모바일 앱 - Face ID / Touch ID / 지문 |

### 5.2 데이터 보안
| 항목 | 구현 방식 |
|------|----------|
| 전송 암호화 | TLS 1.2 이상 (TLS 1.3 권장) |
| 저장 암호화 | AES-256-GCM (연락처 등 개인정보) |
| 암호화 키 관리 | AWS KMS (Key Rotation 활성화) |
| 데이터베이스 | RDS 암호화 활성화 (At-Rest Encryption) |
| 로그 마스킹 | 개인정보 필드 자동 마스킹 |

### 5.3 네트워크 보안
| 항목 | 구현 방식 |
|------|----------|
| ERP 연동 | VPN 또는 전용선 + IP Whitelist |
| Edge Server | API Key 인증 + IP Whitelist |
| 방화벽 | Security Group (최소 권한 원칙) |
| DDoS 방어 | AWS Shield Standard |
| WAF | AWS WAF (OWASP Top 10 규칙) |

### 5.4 보안 체크리스트
- [x] OWASP Top 10 대응
- [x] SQL Injection 방지 (SQLAlchemy ORM 사용)
- [x] XSS 방지 (React 자동 이스케이프 + CSP 헤더)
- [x] CSRF 방지 (SameSite Cookie, CSRF Token)
- [x] Rate Limiting (API 분당 100회 제한)
- [x] 입력값 검증 (Pydantic 스키마 검증)
- [x] 보안 헤더 설정 (HSTS, X-Frame-Options 등)
- [x] 의존성 취약점 스캔 (GitHub Dependabot)

---

## 6. 성능 요구사항 (Performance Requirements)

### 6.1 응답 시간
| 구분 | 목표값 | 측정 방법 |
|------|--------|----------|
| API 응답 (p50) | < 100ms | AWS X-Ray |
| API 응답 (p95) | < 500ms | AWS X-Ray |
| API 응답 (p99) | < 1000ms | AWS X-Ray |
| 웹 페이지 로딩 | < 2s | Lighthouse |
| 모바일 앱 화면 로딩 | < 3s | Firebase Performance |
| WebSocket 메시지 지연 | < 100ms | CloudWatch |

### 6.2 처리량
| 구분 | 목표값 |
|------|--------|
| 웹 동시 접속자 | 50명 이상 |
| API TPS | 100 TPS 이상 |
| WebSocket 동시 연결 | 200 연결 |
| 일일 계량 처리량 | 500건 이상 |

### 6.3 최적화 전략

#### 프론트엔드
- [x] CDN 적용 (CloudFront)
- [x] 이미지 최적화 (WebP, Lazy Loading)
- [x] 번들 최적화 (Code Splitting, Tree Shaking)
- [x] 캐싱 전략 (Service Worker, HTTP Cache)

#### 백엔드
- [x] Database Connection Pooling (SQLAlchemy pool_size=20)
- [x] Query Optimization (인덱스 활용, N+1 방지)
- [x] Redis 캐싱 (대시보드 데이터, 5초 TTL)
- [x] 비동기 처리 (FastAPI async/await)
- [x] 배치 처리 (ERP 전송, 리포트 생성)

#### 데이터베이스
- [x] 읽기 전용 복제본 (통계 쿼리 분리)
- [x] 파티셔닝 (weigh_record 월별 파티션)
- [x] 정기 VACUUM (PostgreSQL 자동 설정)
- [x] 쿼리 실행 계획 모니터링

---

## 7. 인프라 요구사항 (Infrastructure Requirements)

### 7.1 서버 구성
| 환경 | 구성 | 스펙 | 수량 |
|------|------|------|------|
| Development | ECS Fargate | 0.5 vCPU, 1GB | 1 Task |
| Staging | ECS Fargate | 1 vCPU, 2GB | 2 Tasks |
| Production | ECS Fargate | 2 vCPU, 4GB | 2~4 Tasks (Auto Scaling) |

| 구성요소 | Development | Staging | Production |
|----------|-------------|---------|------------|
| RDS | db.t3.micro | db.t3.small | db.r6g.large, Multi-AZ |
| ElastiCache | cache.t3.micro | cache.t3.small | cache.r6g.large |
| ALB | 1개 | 1개 | 1개 |
| S3 | 1 Bucket | 1 Bucket | 1 Bucket (Versioning) |

### 7.2 Edge Server 구성
| 항목 | 스펙 |
|------|------|
| 하드웨어 | 산업용 미니 PC |
| CPU | Intel N100 이상 |
| RAM | 8GB |
| Storage | 256GB SSD |
| OS | Ubuntu 22.04 LTS |
| 네트워크 | 유선 이더넷 (고정 IP) |
| 시리얼 포트 | RS-232 3포트 (USB-to-Serial 어댑터) |

### 7.3 배포 전략
- 배포 방식: **Blue-Green Deployment**
  - ECS 서비스의 Rolling Update 사용
  - 최소 50% 인스턴스 유지
  - 헬스체크 실패 시 자동 롤백
- 배포 프로세스:
  1. GitHub PR 머지 → main 브랜치
  2. GitHub Actions CI 실행 (테스트, 빌드)
  3. Docker 이미지 빌드 → ECR 푸시
  4. ECS 서비스 업데이트 (새 Task Definition)
  5. 헬스체크 통과 → 트래픽 전환
  6. 기존 Task 종료

### 7.4 백업 정책
| 대상 | 주기 | 보관 기간 |
|------|------|----------|
| RDS 스냅샷 | 일 1회 (자동) | 7일 |
| RDS 수동 스냅샷 | 주 1회 | 30일 |
| S3 전표 이미지 | - | 5년 (규정 준수) |
| 로그 | - | 90일 |

### 7.5 모니터링
| 대상 | 도구 | 알림 조건 |
|------|------|----------|
| API 서버 | CloudWatch + X-Ray | 응답시간 p95 > 1s, 에러율 > 1% |
| 데이터베이스 | CloudWatch | CPU > 80%, 커넥션 > 90% |
| 캐시 | CloudWatch | 메모리 > 80%, 커넥션 > 1000 |
| Edge Server | Prometheus + Grafana | 연결 끊김, 버퍼 오버플로우 |
| 로그 | CloudWatch Logs Insights | ERROR 로그 발생 시 |
| 비용 | AWS Budgets | 월 예산 80% 도달 시 |

### 7.6 알림 채널
| 심각도 | 채널 | 대상 |
|--------|------|------|
| Critical | PagerDuty + SMS | 운영팀 전체 |
| Warning | Slack #alerts | 개발팀 |
| Info | Slack #monitoring | 개발팀 |

---

## 8. 기술 리스크 (Technical Risks)

| ID | 리스크 | 영향도 | 발생 가능성 | 대응 방안 |
|----|--------|--------|------------|----------|
| TR-001 | B사 인디케이터 프로토콜 미확정 | HIGH | MEDIUM | 프로토콜 문서 수령 일정 확정, 범용 파서 구조로 설계 |
| TR-002 | Edge Server 네트워크 단절 | HIGH | MEDIUM | SQLite 로컬 버퍼링, 네트워크 복구 시 자동 동기화 |
| TR-003 | ERP 연동 API 변경 | MEDIUM | LOW | 어댑터 패턴 적용, 버전 관리 |
| TR-004 | 모바일 앱 스토어 심사 지연 | MEDIUM | MEDIUM | 조기 심사 제출, 사전 리젝 사유 검토 |
| TR-005 | 레거시 전광판 호환성 | LOW | MEDIUM | 프로토콜 테스트 선행, 필요 시 교체 검토 |
| TR-006 | 동시 접속 부하 | MEDIUM | LOW | 부하 테스트 수행, Auto Scaling 설정 검증 |
| TR-007 | 개인정보 보안 사고 | HIGH | LOW | 암호화 적용, 접근 로그 모니터링, 정기 보안 점검 |

---

## 9. 참고 문서

- 기반 PRD: `workspace/outputs/prd/PRD-20260125-143000.md`
- 기반 PRD (JSON): `workspace/outputs/prd/PRD-20260125-143000.json`

---
*이 문서는 TRD 자동 생성 시스템에 의해 작성되었습니다.*
