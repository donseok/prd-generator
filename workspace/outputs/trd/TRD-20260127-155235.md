# 부산 스마트 계량 시스템 구축 TRD (Technical Requirements Document)

**버전**: 1.0
**작성일**: 2026-01-27
**기반 PRD**: PRD-20260127-154446
**상태**: Draft

---

## 1. 기술 스택 (Technology Stack)

### 1.1 Frontend (Web)
| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Framework | React | 18.x | PRD 제약조건 명시, 컴포넌트 기반 SPA로 실시간 계량 현황 대시보드에 적합 |
| State Management | Zustand | 4.x | 경량 상태관리, React 18 호환, Redux 대비 보일러플레이트 감소 |
| UI Library | Ant Design | 5.x | 엔터프라이즈급 데이터 테이블 (필터, 정렬, 소계, 셀고정), 차트 컴포넌트 내장 |
| Chart Library | Apache ECharts | 5.x | 다양한 차트 유형 지원, 실시간 데이터 시각화, 대시보드 구성 |
| HTTP Client | Axios | 1.x | REST API 통신, 인터셉터 기반 인증 토큰 관리 |
| Build Tool | Vite | 5.x | 빠른 HMR, 최적화된 프로덕션 빌드, React 18 공식 지원 |
| Language | TypeScript | 5.x | 타입 안정성, 대규모 프로젝트 유지보수성 향상 |

### 1.2 Frontend (Mobile APP)
| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Framework | Flutter | 3.x | PRD 제약조건 명시, iOS/Android 크로스 플랫폼, 단일 코드베이스 |
| Language | Dart | 3.x | Flutter 공식 언어, AOT 컴파일 성능 |
| State Management | Riverpod | 2.x | 타입 안전한 상태관리, Provider 개선판 |
| Push Notification | Firebase Cloud Messaging (FCM) | - | Android/iOS 통합 Push 알림, 카카오 알림톡 연동 |
| Local Storage | Hive | 2.x | 경량 로컬 DB, 오프라인 캐싱 |

### 1.3 Backend
| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Language | Java | 17 LTS | Spring Boot 3.x 기본 지원, 장기 지원 버전, 기업 표준 |
| Framework | Spring Boot | 3.2.x | PRD 제약조건 명시, 엔터프라이즈급 안정성, WEB/WAS 통합 |
| Security | Spring Security | 6.x | JWT 인증, RBAC 권한 관리, OTP 보안 통합 |
| ORM | Spring Data JPA + QueryDSL | 3.x / 5.x | 타입 안전한 동적 쿼리, 복잡한 조회 조건 지원 |
| API Documentation | SpringDoc OpenAPI | 2.x | Swagger UI 자동 생성, API 명세 표준화 |
| Messaging | Spring WebSocket + STOMP | 6.x | 계량 실시간 데이터 전송, H/W 상태 모니터링 |
| Scheduling | Spring Scheduler + Quartz | 2.x | 배차 스케줄링, 알림 발송 배치 처리 |

### 1.4 계량대 CS 프로그램
| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| IDE | Visual Studio 2022 Professional | 17.x | PRD 제약조건 명시, C# 개발 환경 |
| Language | C# | 11 (.NET 7+) | Windows 기반 계량대 PC, 시리얼 통신 지원 |
| Framework | .NET WinForms / WPF | 7+ | 터치스크린 UI, 기존 계량 PC 호환 |
| Serial Comm | System.IO.Ports | - | RS-232C 인디게이터 통신, LPR/센서 데이터 수신 |
| HTTP Client | HttpClient | - | 계량 서버 REST API 연동 |

### 1.5 Database
| 구분 | 기술 | 버전 | 선정 사유 |
|------|------|------|----------|
| Primary DB | PostgreSQL | 16.x | PRD 제약조건 명시, ACID 트랜잭션, JSON 지원, 확장성 |
| Cache | Redis | 7.x | OTP 임시 저장, 세션 캐싱, 실시간 계량 상태 |
| Message Queue | Redis Streams | 7.x | 계량 이벤트 비동기 처리, H/W → 서버 이벤트 전달 |

### 1.6 Infrastructure
| 구분 | 기술 | 선정 사유 |
|------|------|----------|
| Server OS | CentOS / Rocky Linux 9 | 기업 온프레미스 서버 표준, 안정성 |
| WEB/WAS | Spring Boot Embedded Tomcat | Spring Boot 내장, 별도 WAS 불요 |
| Reverse Proxy | Nginx | 1.24.x | SSL 종단, 로드밸런싱, 정적 파일 서빙 |
| Containerization | Docker + Docker Compose | 개발/스테이징 환경 일관성, 배포 간소화 |
| CI/CD | Jenkins / GitLab CI | 사내 표준 CI/CD, 자동화 빌드/배포 |
| Monitoring | Prometheus + Grafana | 시스템/애플리케이션 메트릭, 알림, 대시보드 |
| Log Management | ELK Stack (Elasticsearch + Logstash + Kibana) | 중앙 집중 로그, 검색, 시각화 |
| VCS | Git (GitLab) | 소스코드 버전 관리, 코드 리뷰, MR 워크플로 |

---

## 2. 시스템 아키텍처 (System Architecture)

### 2.1 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              부산공장 계량대 현장                                   │
│                                                                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │  LPR     │  │ LiDAR    │  │ 레이더   │  │ 차량     │  │ 인디     │          │
│  │ 카메라   │  │ 센서     │  │ 센서     │  │ 검지기   │  │ 게이터   │          │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘          │
│       │              │              │              │              │               │
│       └──────────────┴──────────────┴──────────────┴──────────────┘               │
│                                     │                                             │
│                          ┌──────────▼──────────┐                                  │
│                          │  계량대 CS 프로그램   │◄──── RS-232C (인디게이터)        │
│                          │  (C# / .NET)         │                                  │
│                          │  - LPR 자동계량       │──── TCP/UDP (LPR/센서)           │
│                          │  - 모바일 계량        │                                  │
│                          │  - 수동 계량          │                                  │
│                          └──────────┬──────────┘                                  │
│                                     │                                             │
│  ┌──────────┐  ┌──────────┐        │        ┌──────────┐                         │
│  │ 전광판   │  │ 자동     │        │        │ 인터폰   │                         │
│  │ (OTP)    │  │ 차단기   │        │        │ (자기/모기)│                        │
│  └──────────┘  └──────────┘        │        └──────────┘                         │
└─────────────────────────────────────┼─────────────────────────────────────────────┘
                                      │ HTTPS (REST API)
                                      │
┌─────────────────────────────────────┼─────────────────────────────────────────────┐
│                              서버 인프라                                           │
│                                     │                                             │
│              ┌──────────────────────▼──────────────────────┐                      │
│              │              Nginx (Reverse Proxy)          │                      │
│              │         SSL 종단 / 로드밸런싱                │                      │
│              └──────────┬──────────────────┬───────────────┘                      │
│                         │                  │                                       │
│              ┌──────────▼─────┐  ┌────────▼────────┐                              │
│              │  Spring Boot   │  │  Spring Boot    │                              │
│              │  WEB/WAS #1    │  │  WEB/WAS #2     │                              │
│              │  (API Server)  │  │  (API Server)   │                              │
│              └──────┬─────────┘  └────────┬────────┘                              │
│                     │                      │                                       │
│              ┌──────▼──────────────────────▼────────┐                              │
│              │         Service Layer                │                              │
│              │  - 계량관리 서비스                     │                              │
│              │  - 배차관리 서비스                     │                              │
│              │  - 사용자/인증 서비스                  │                              │
│              │  - 알림 서비스                         │                              │
│              │  - AI 차량인식 연동 서비스             │                              │
│              └──────┬──────────────┬────────────────┘                              │
│                     │              │                                               │
│         ┌───────────▼──┐   ┌──────▼──────┐   ┌───────────┐                       │
│         │ PostgreSQL   │   │   Redis     │   │ AI 인식   │                       │
│         │ (Primary DB) │   │ (Cache/OTP/ │   │ Engine    │                       │
│         │              │   │  MQ/Session)│   │ (외부/내부)│                       │
│         └──────────────┘   └─────────────┘   └───────────┘                       │
│                                                                                   │
│         ┌───────────────────────────────────────────┐                             │
│         │  Monitoring: Prometheus + Grafana          │                             │
│         │  Logging: ELK Stack                        │                             │
│         └───────────────────────────────────────────┘                             │
└───────────────────────────────────────────────────────────────────────────────────┘
                                      │
                           ┌──────────┼──────────┐
                           │          │          │
                    ┌──────▼──┐ ┌─────▼───┐ ┌───▼──────────┐
                    │ 웹 브라 │ │ 모바일  │ │ 외부 서비스   │
                    │ 우저    │ │ APP     │ │              │
                    │ (React) │ │(Flutter)│ │ - 카카오 API │
                    │         │ │         │ │ - SMS 서비스 │
                    │         │ │         │ │ - FCM/APNs   │
                    └─────────┘ └─────────┘ └──────────────┘
```

### 2.2 컴포넌트 설명
| 컴포넌트 | 역할 | 기술 |
|----------|------|------|
| 계량대 CS 프로그램 | H/W 장비 연동, 중량값 수신, LPR/모바일/수동 계량 처리, 전광판/차단기 제어 | C# .NET WinForms |
| Nginx Reverse Proxy | SSL 종단, 로드밸런싱, 정적 리소스 서빙, WebSocket 프록시 | Nginx 1.24 |
| Spring Boot API Server | REST API 제공, 비즈니스 로직 처리, 인증/인가, WebSocket | Spring Boot 3.2 |
| AI 차량인식 Engine | LPR 촬영 이미지에서 차량번호 추출·검증, 95% 이상 인식률 | 외부 솔루션 or 자체 개발 (미결정) |
| PostgreSQL DB | 배차, 계량실적, 사용자, 기준정보 등 핵심 데이터 영구 저장 | PostgreSQL 16 |
| Redis | OTP 임시 저장(TTL), 세션 캐싱, 실시간 계량 상태, 이벤트 MQ | Redis 7 |
| React Web App | 계량관리 웹 시스템 (배차등록, 계량관리, 기준정보, 출문관리, 대시보드) | React 18 + Ant Design |
| Flutter Mobile App | 계량관리 APP (로그인, 배차조회, 계량진행, 전자계량표, OTP) | Flutter 3.x |
| FCM/APNs | 계량 완료 Push 알림, 알림톡 발송 | Firebase Cloud Messaging |
| 카카오 API / SMS | 전자 계량표 공유, 알림톡 발송 | 카카오비즈 API, SMS Gateway |

### 2.3 통신 방식
| From | To | 프로토콜 | 설명 |
|------|-----|---------|------|
| LPR/센서 장비 | 계량대 CS | TCP/UDP | 차량번호 인식 데이터, 센서 감지 이벤트 전송 |
| 인디게이터 | 계량대 CS | RS-232C (Serial) | 안정화 중량값 실시간 수신 |
| 계량대 CS | 전광판/차단기 | TCP/RS-485 | OTP 표시, 차단기 개폐 제어 명령 |
| 계량대 CS | API Server | HTTPS (REST) | 계량 실적 전송, 배차 정보 조회, 인증 |
| React Web | API Server | HTTPS (REST) | 배차등록, 계량관리, 기준정보 CRUD |
| React Web | API Server | WSS (WebSocket) | 실시간 계량 현황, 대시보드 업데이트 |
| Flutter App | API Server | HTTPS (REST) | 배차조회, 모바일 계량, OTP 인증, 전자계량표 |
| API Server | PostgreSQL | TCP (5432) | 데이터 읽기/쓰기, 트랜잭션 처리 |
| API Server | Redis | TCP (6379) | OTP 저장/검증, 세션 캐싱, 이벤트 발행 |
| API Server | AI Engine | HTTPS (REST) | 차량번호 이미지 전송, 인식 결과 수신 |
| API Server | 카카오 API | HTTPS (REST) | 알림톡 발송, 계량표 공유 |
| API Server | SMS Gateway | HTTPS (REST) | SMS 알림 발송 |
| API Server | FCM | HTTPS | Push 알림 발송 (Android/iOS) |

---

## 3. 데이터베이스 설계 (Database Design)

### 3.1 엔티티 관계도 (ERD)

```
┌──────────────────┐       ┌──────────────────┐       ┌──────────────────┐
│     tb_user      │       │   tb_company     │       │   tb_vehicle     │
├──────────────────┤       ├──────────────────┤       ├──────────────────┤
│ user_id (PK)     │──┐    │ company_id (PK)  │──┐    │ vehicle_id (PK)  │
│ company_id (FK)  │──┘──▶ │ company_name     │  │    │ plate_number     │
│ user_name        │       │ company_type     │  │    │ company_id (FK)  │──▶
│ phone_number     │       │ contact_phone    │  │    │ vehicle_type     │
│ user_role        │       │ is_active        │  │    │ is_active        │
│ login_id         │       └──────────────────┘  │    └────────┬─────────┘
│ password_hash    │                              │             │
│ is_active        │                              │             │
└──────────────────┘                              │             │
        │                                         │             │
        │                                         │             │
        ▼                                         │             │
┌──────────────────┐       ┌──────────────────┐   │             │
│ tb_otp_session   │       │  tb_dispatch     │   │             │
├──────────────────┤       ├──────────────────┤   │             │
│ otp_id (PK)      │       │ dispatch_id (PK) │   │             │
│ user_id (FK)     │       │ vehicle_id (FK)  │───┘─────────────┘
│ otp_code         │       │ company_id (FK)  │───┘
│ vehicle_id (FK)  │       │ item_type        │
│ expires_at       │       │ item_name        │
│ is_verified      │       │ dispatch_date    │
│ created_at       │       │ dispatch_status  │
└──────────────────┘       │ created_by (FK)  │
                           │ created_at       │
                           └────────┬─────────┘
                                    │
                                    │ 1:N
                                    ▼
                           ┌──────────────────┐       ┌──────────────────┐
                           │ tb_weighing      │       │ tb_weighing_log  │
                           ├──────────────────┤       ├──────────────────┤
                           │ weighing_id (PK) │──────▶│ log_id (PK)      │
                           │ dispatch_id (FK) │       │ weighing_id (FK) │
                           │ vehicle_id (FK)  │       │ log_type         │
                           │ scale_id (FK)    │       │ log_message      │
                           │ weighing_type    │       │ created_at       │
                           │ weighing_step    │       └──────────────────┘
                           │ gross_weight     │
                           │ tare_weight      │       ┌──────────────────┐
                           │ net_weight       │       │ tb_weighing_slip │
                           │ weighing_mode    │       ├──────────────────┤
                           │ lpr_plate_number │──────▶│ slip_id (PK)     │
                           │ ai_confidence    │       │ weighing_id (FK) │
                           │ status           │       │ slip_number      │
                           │ weighed_at       │       │ slip_data (JSON) │
                           │ created_at       │       │ shared_via       │
                           └──────────────────┘       │ shared_at        │
                                    │                 │ created_at       │
                                    │                 └──────────────────┘
                                    │
                           ┌────────▼─────────┐       ┌──────────────────┐
                           │  tb_scale        │       │ tb_gate_pass     │
                           ├──────────────────┤       ├──────────────────┤
                           │ scale_id (PK)    │       │ gate_pass_id(PK) │
                           │ scale_name       │       │ weighing_id (FK) │
                           │ location         │       │ dispatch_id (FK) │
                           │ scale_type       │       │ pass_status      │
                           │ is_active        │       │ passed_at        │
                           └──────────────────┘       │ created_at       │
                                                      └──────────────────┘
┌──────────────────┐       ┌──────────────────┐
│ tb_master_code   │       │ tb_notification  │
├──────────────────┤       ├──────────────────┤
│ code_id (PK)     │       │ noti_id (PK)     │
│ code_group       │       │ user_id (FK)     │
│ code_value       │       │ noti_type        │
│ code_name        │       │ title            │
│ sort_order       │       │ message          │
│ is_active        │       │ is_read          │
│ parent_code_id   │       │ sent_at          │
└──────────────────┘       └──────────────────┘

┌──────────────────┐
│ tb_inquiry_call  │
├──────────────────┤
│ call_id (PK)     │
│ user_id (FK)     │
│ inquiry_type     │
│ target_dept      │
│ call_status      │
│ created_at       │
└──────────────────┘
```

### 3.2 테이블 명세

#### tb_user (사용자)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| user_id | BIGSERIAL | NO | AUTO | PK |
| company_id | BIGINT | YES | NULL | FK → tb_company, 소속 운송사 |
| user_name | VARCHAR(50) | NO | - | 사용자 이름 |
| phone_number | VARCHAR(20) | NO | - | 전화번호 (모바일 OTP 인증용) |
| user_role | VARCHAR(20) | NO | - | ADMIN, MANAGER, DRIVER |
| login_id | VARCHAR(50) | NO | - | 로그인 ID |
| password_hash | VARCHAR(255) | NO | - | 비밀번호 해시 (bcrypt) |
| is_active | BOOLEAN | NO | true | 활성 상태 |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 수정일시 |

#### tb_vehicle (차량)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| vehicle_id | BIGSERIAL | NO | AUTO | PK |
| plate_number | VARCHAR(20) | NO | - | 차량번호 (LPR 매칭용), UNIQUE |
| company_id | BIGINT | YES | NULL | FK → tb_company |
| vehicle_type | VARCHAR(20) | NO | - | 차량 유형 |
| max_load_weight | DECIMAL(10,2) | YES | NULL | 최대 적재 중량(kg) |
| is_active | BOOLEAN | NO | true | 활성 상태 |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |

#### tb_dispatch (배차)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| dispatch_id | BIGSERIAL | NO | AUTO | PK |
| vehicle_id | BIGINT | NO | - | FK → tb_vehicle |
| company_id | BIGINT | NO | - | FK → tb_company |
| item_type | VARCHAR(20) | NO | - | 부산물, 폐기물, 부재료, 반출, 일반 |
| item_name | VARCHAR(100) | NO | - | 품목명 |
| dispatch_date | DATE | NO | - | 배차 일자 |
| dispatch_status | VARCHAR(20) | NO | REGISTERED | REGISTERED, IN_PROGRESS, COMPLETED, CANCELLED |
| origin_location | VARCHAR(100) | YES | NULL | 출발지 |
| destination | VARCHAR(100) | YES | NULL | 도착지 |
| remarks | TEXT | YES | NULL | 비고 |
| created_by | BIGINT | NO | - | FK → tb_user |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 수정일시 |

#### tb_weighing (계량실적)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| weighing_id | BIGSERIAL | NO | AUTO | PK |
| dispatch_id | BIGINT | NO | - | FK → tb_dispatch |
| vehicle_id | BIGINT | NO | - | FK → tb_vehicle |
| scale_id | BIGINT | NO | - | FK → tb_scale |
| weighing_type | VARCHAR(20) | NO | - | FIRST, SECOND, THIRD (1차/2차/3차) |
| weighing_step | VARCHAR(20) | NO | - | GROSS, TARE, COMPLETE |
| gross_weight | DECIMAL(10,2) | YES | NULL | 총 중량(kg) |
| tare_weight | DECIMAL(10,2) | YES | NULL | 차량 자체 중량(kg) |
| net_weight | DECIMAL(10,2) | YES | NULL | 순 중량(kg) = gross - tare |
| weighing_mode | VARCHAR(20) | NO | - | LPR_AUTO, MOBILE_OTP, MANUAL, RE_WEIGH |
| lpr_plate_number | VARCHAR(20) | YES | NULL | LPR 인식 차량번호 |
| ai_confidence | DECIMAL(5,4) | YES | NULL | AI 차량번호 인식 신뢰도 (0.0~1.0) |
| lpr_image_path | VARCHAR(500) | YES | NULL | LPR 촬영 이미지 저장 경로 |
| status | VARCHAR(20) | NO | IN_PROGRESS | IN_PROGRESS, COMPLETED, RE_WEIGHING, ERROR |
| weighed_at | TIMESTAMPTZ | YES | NULL | 계량 완료 시각 |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 수정일시 |

#### tb_weighing_slip (전자 계량표)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| slip_id | BIGSERIAL | NO | AUTO | PK |
| weighing_id | BIGINT | NO | - | FK → tb_weighing |
| slip_number | VARCHAR(30) | NO | - | 계량표 번호 (자동 채번), UNIQUE |
| slip_data | JSONB | NO | - | 계량표 상세 데이터 (JSON) |
| shared_via | VARCHAR(20) | YES | NULL | KAKAO, SMS, NONE |
| shared_at | TIMESTAMPTZ | YES | NULL | 공유 일시 |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |

#### tb_otp_session (OTP 세션)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| otp_id | BIGSERIAL | NO | AUTO | PK |
| user_id | BIGINT | YES | NULL | FK → tb_user |
| otp_code | VARCHAR(6) | NO | - | 6자리 OTP 코드 |
| vehicle_id | BIGINT | YES | NULL | FK → tb_vehicle |
| phone_number | VARCHAR(20) | NO | - | 인증 전화번호 |
| expires_at | TIMESTAMPTZ | NO | - | 만료 시각 (생성 후 5분) |
| is_verified | BOOLEAN | NO | false | 검증 완료 여부 |
| created_at | TIMESTAMPTZ | NO | NOW() | 생성일시 |

#### tb_scale (계량대)
| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| scale_id | BIGSERIAL | NO | AUTO | PK |
| scale_name | VARCHAR(50) | NO | - | 계량대 명칭 |
| location | VARCHAR(100) | NO | - | 설치 위치 |
| scale_type | VARCHAR(20) | NO | - | SMART, MANUAL |
| max_capacity | DECIMAL(10,2) | YES | NULL | 최대 용량(kg) |
| is_active | BOOLEAN | NO | true | 운영 상태 |
| last_calibrated_at | TIMESTAMPTZ | YES | NULL | 최종 교정 일시 |

### 3.3 인덱스 전략
| 테이블 | 인덱스명 | 컬럼 | 유형 | 용도 |
|--------|---------|------|------|------|
| tb_vehicle | idx_vehicle_plate | plate_number | B-Tree UNIQUE | LPR 차량번호 매칭 (핵심 조회) |
| tb_dispatch | idx_dispatch_date_status | dispatch_date, dispatch_status | B-Tree | 일별 배차 현황 조회 |
| tb_dispatch | idx_dispatch_vehicle | vehicle_id | B-Tree | 차량별 배차 이력 |
| tb_dispatch | idx_dispatch_company | company_id | B-Tree | 운송사별 배차 조회 |
| tb_weighing | idx_weighing_dispatch | dispatch_id | B-Tree | 배차별 계량 실적 |
| tb_weighing | idx_weighing_vehicle | vehicle_id | B-Tree | 차량별 계량 이력 |
| tb_weighing | idx_weighing_date | weighed_at | B-Tree | 기간별 실적 조회 |
| tb_weighing | idx_weighing_status | status | B-Tree | 상태별 필터링 |
| tb_weighing | idx_weighing_mode | weighing_mode | B-Tree | 계량 방식별 통계 |
| tb_weighing_slip | idx_slip_number | slip_number | B-Tree UNIQUE | 계량표 번호 검색 |
| tb_otp_session | idx_otp_code_expires | otp_code, expires_at | B-Tree | OTP 코드 검증 |
| tb_otp_session | idx_otp_phone | phone_number | B-Tree | 전화번호 기반 OTP 조회 |
| tb_user | idx_user_login | login_id | B-Tree UNIQUE | 로그인 ID 조회 |
| tb_user | idx_user_phone | phone_number | B-Tree | 전화번호 기반 사용자 조회 |
| tb_notification | idx_noti_user_read | user_id, is_read | B-Tree | 사용자별 미읽은 알림 |

---

## 4. API 명세 (API Specification)

### 4.1 공통 사항
- Base URL: `/api/v1`
- 인증: Bearer Token (JWT) - Access Token (30분) + Refresh Token (7일)
- 응답 형식: JSON (application/json)
- 공통 응답 구조:

```json
{
  "success": true,
  "data": { ... },
  "message": "성공",
  "timestamp": "2026-01-27T15:00:00+09:00"
}
```

- 공통 에러 응답:

```json
{
  "success": false,
  "error": {
    "code": "ERR_001",
    "message": "에러 설명"
  },
  "timestamp": "2026-01-27T15:00:00+09:00"
}
```

### 4.2 인증 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| POST | /auth/login | 로그인 (ID/PW) | Not Required |
| POST | /auth/login/otp | OTP 기반 로그인 (모바일) | Not Required |
| POST | /auth/refresh | Access Token 갱신 | Refresh Token |
| POST | /auth/logout | 로그아웃 | Required |

##### POST /auth/login
**Request**:
```json
{
  "login_id": "string",
  "password": "string",
  "device_type": "WEB | MOBILE"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "access_token": "jwt_token",
    "refresh_token": "refresh_token",
    "user": {
      "user_id": 1,
      "user_name": "홍길동",
      "user_role": "DRIVER",
      "company_name": "ABC운수"
    },
    "expires_in": 1800
  }
}
```

### 4.3 배차관리 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | /dispatches | 배차 목록 조회 | Required |
| POST | /dispatches | 배차 등록 | Required (ADMIN, MANAGER) |
| GET | /dispatches/{id} | 배차 상세 조회 | Required |
| PUT | /dispatches/{id} | 배차 수정 | Required (ADMIN, MANAGER) |
| DELETE | /dispatches/{id} | 배차 삭제 | Required (ADMIN) |
| GET | /dispatches/my | 내 배차 목록 (운전자) | Required (DRIVER) |

##### GET /dispatches
**Query Parameters**:
- `dispatch_date` (date, optional): 배차 일자 필터
- `item_type` (string, optional): 품목 유형 필터
- `status` (string, optional): 상태 필터
- `company_id` (integer, optional): 운송사 필터
- `page` (integer, default: 1): 페이지 번호
- `size` (integer, default: 20): 페이지 크기

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "dispatch_id": 1,
        "vehicle_plate": "12가3456",
        "company_name": "ABC운수",
        "item_type": "부산물",
        "item_name": "슬래그",
        "dispatch_date": "2026-01-27",
        "dispatch_status": "REGISTERED"
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total_count": 150,
      "total_pages": 8
    }
  }
}
```

### 4.4 계량관리 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| POST | /weighings | 계량 시작 (LPR 자동/모바일/수동) | Required |
| PUT | /weighings/{id}/complete | 계량 완료 처리 | Required |
| PUT | /weighings/{id}/re-weigh | 재계량 처리 | Required |
| GET | /weighings | 계량 실적 목록 조회 | Required |
| GET | /weighings/{id} | 계량 상세 조회 | Required |
| GET | /weighings/realtime | 실시간 계량 현황 (WebSocket 업그레이드) | Required |
| GET | /weighings/statistics | 계량 통계 (일별/월별/품목별) | Required |

##### POST /weighings
**Request**:
```json
{
  "dispatch_id": 1,
  "scale_id": 1,
  "weighing_mode": "LPR_AUTO | MOBILE_OTP | MANUAL",
  "weighing_type": "FIRST | SECOND | THIRD",
  "weight_value": 15000.50,
  "lpr_plate_number": "12가3456",
  "ai_confidence": 0.9823
}
```

### 4.5 OTP 인증 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| POST | /otp/generate | OTP 생성 (전광판 표시용) | Internal |
| POST | /otp/verify | OTP 검증 (모바일 입력) | Not Required |

##### POST /otp/verify
**Request**:
```json
{
  "otp_code": "123456",
  "phone_number": "010-1234-5678"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "verified": true,
    "vehicle_id": 1,
    "plate_number": "12가3456",
    "dispatch_id": 5
  }
}
```

### 4.6 전자 계량표 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | /slips/{weighing_id} | 전자 계량표 조회 | Required |
| POST | /slips/{slip_id}/share | 계량표 공유 (카카오톡/SMS) | Required |
| GET | /slips/history | 계량표 이력 조회 | Required |

### 4.7 알림 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | /notifications | 알림 목록 조회 | Required |
| PUT | /notifications/{id}/read | 알림 읽음 처리 | Required |
| POST | /notifications/push/register | FCM 토큰 등록 | Required |

### 4.8 기준정보 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | /master/companies | 운송사 목록 | Required |
| GET | /master/vehicles | 차량 목록 | Required |
| GET | /master/scales | 계량대 목록 | Required |
| GET | /master/codes/{group} | 공통 코드 조회 | Required |
| POST | /master/companies | 운송사 등록 | Required (ADMIN) |
| POST | /master/vehicles | 차량 등록 | Required (ADMIN) |

### 4.9 출문관리 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | /gate-passes | 출문 목록 조회 | Required |
| POST | /gate-passes | 출문 처리 | Required (MANAGER) |
| PUT | /gate-passes/{id} | 출문 상태 변경 | Required (MANAGER) |

### 4.10 문의/통화 API

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | /inquiries/contacts | 문의유형별 연락처 목록 | Required |
| POST | /inquiries/call-log | 통화 이력 기록 | Required |

---

## 5. 보안 요구사항 (Security Requirements)

### 5.1 인증/인가
| 항목 | 구현 방식 |
|------|----------|
| 인증 | JWT (Access Token 30분 + Refresh Token 7일) |
| 권한 관리 | RBAC - ADMIN(시스템관리자), MANAGER(계량담당자), DRIVER(운전자) |
| 세션 관리 | Redis 기반 Refresh Token 저장, 동시 세션 제한 |
| OTP 인증 | TOTP 기반 6자리 숫자, 유효시간 5분, Redis TTL 관리 |
| 모바일 인증 | 전화번호 + 인증번호 기반 안전 로그인 |

### 5.2 데이터 보안
| 항목 | 구현 방식 |
|------|----------|
| 전송 암호화 | TLS 1.3 (Nginx SSL 종단) |
| 비밀번호 저장 | bcrypt (cost factor 12) |
| 개인정보 | 전화번호, 차량번호 마스킹 처리 (로그, 화면표시) |
| DB 암호화 | 민감 컬럼 AES-256 암호화 (phone_number 등) |
| API 키 관리 | Spring Vault 또는 환경변수 기반 시크릿 관리 |

### 5.3 보안 정책
- [x] OWASP Top 10 대응 (Spring Security 기본 적용)
- [x] SQL Injection 방지 (JPA Parameterized Query)
- [x] XSS 방지 (React 자동 이스케이프 + CSP 헤더)
- [x] CSRF 방지 (JWT 기반 Stateless, SameSite Cookie)
- [x] Rate Limiting (Nginx limit_req, API별 차등 적용)
- [x] CORS 정책 (허용 Origin 화이트리스트)
- [x] 입력값 검증 (Bean Validation, DTO 검증)
- [x] 로그 감사 (로그인/계량/배차 변경 이력 기록)

### 5.4 네트워크 보안
| 항목 | 구현 방식 |
|------|----------|
| 방화벽 | 서버 간 필요 포트만 허용 (5432, 6379, 8080, 443) |
| VPN | 계량대 CS ↔ 서버 간 사내 네트워크 VPN 연결 |
| DB 접근 | 애플리케이션 서버에서만 접근 허용 |
| 외부 API | 화이트리스트 기반 아웃바운드 허용 (카카오, FCM) |

---

## 6. 성능 요구사항 (Performance Requirements)

### 6.1 응답 시간
| 구분 | 목표값 | 측정 방법 |
|------|--------|----------|
| LPR 인식 → 자동 계량 완료 | < 3초 (E2E) | 애플리케이션 로그 타임스탬프 |
| API 응답 (p50) | < 200ms | Prometheus + Spring Actuator |
| API 응답 (p95) | < 500ms | Prometheus + Spring Actuator |
| API 응답 (p99) | < 1,000ms | Prometheus + Spring Actuator |
| 웹 페이지 로딩 (FCP) | < 2초 | Lighthouse |
| 웹 페이지 로딩 (LCP) | < 3초 | Lighthouse |
| 모바일 APP 화면 전환 | < 1초 | Flutter DevTools |
| WebSocket 데이터 전달 | < 500ms | 서버 로그 |

### 6.2 처리량
| 구분 | 목표값 |
|------|--------|
| 동시 웹 접속자 | 50명 이상 |
| 동시 모바일 접속자 | 200명 이상 |
| API TPS (평상시) | 100 TPS |
| API TPS (피크) | 300 TPS |
| 일일 계량 처리 건수 | 500건 이상 |

### 6.3 최적화 전략
- [x] Redis 캐싱: 기준정보, 배차 목록, 차량 정보 (TTL 5분)
- [x] Database Connection Pooling: HikariCP (min: 10, max: 30)
- [x] Query Optimization: QueryDSL 동적 쿼리, 페이징, 인덱스 활용
- [x] Static Resource CDN: Nginx 정적 파일 캐싱 (JS/CSS/Image)
- [x] API Response Compression: Gzip (Nginx)
- [x] Lazy Loading: React 컴포넌트 코드 스플리팅
- [x] DB Read Replica: 읽기 부하 분산 (향후 확장 시)
- [x] 이미지 최적화: LPR 촬영 이미지 리사이즈 저장

---

## 7. 인프라 요구사항 (Infrastructure Requirements)

### 7.1 서버 구성
| 환경 | 구성 | 스펙 | 용도 |
|------|------|------|------|
| Development | VM 1대 | 4 vCPU, 16GB RAM, 200GB SSD | 개발/테스트 통합 환경 |
| Staging | VM 2대 | 4 vCPU, 16GB RAM, 200GB SSD | 사전 검증 (WAS + DB 분리) |
| Production - WAS | VM 2대 (Active-Active) | 8 vCPU, 32GB RAM, 100GB SSD | Spring Boot API Server (이중화) |
| Production - DB | VM 1대 (+ Standby) | 8 vCPU, 32GB RAM, 500GB SSD | PostgreSQL Primary + Standby |
| Production - Redis | VM 1대 | 4 vCPU, 16GB RAM, 50GB SSD | Redis (Cache/OTP/Session) |
| Production - Nginx | VM 1대 | 2 vCPU, 4GB RAM, 50GB SSD | Reverse Proxy, SSL 종단 |
| Monitoring | VM 1대 | 4 vCPU, 8GB RAM, 200GB SSD | Prometheus, Grafana, ELK |

### 7.2 배포 전략
- 배포 방식: **Rolling Update** (Spring Boot 2대 순차 배포)
- 롤백 전략: 이전 버전 Docker 이미지 태그로 즉시 롤백 (< 5분)
- 배포 프로세스:
  1. 코드 MR → 코드 리뷰 → Merge
  2. Jenkins 빌드 → Docker 이미지 생성 → Registry Push
  3. Staging 자동 배포 → 스모크 테스트
  4. Production 승인 배포 → 순차 Rolling Update
  5. 헬스체크 확인 → 배포 완료

### 7.3 백업 전략
| 대상 | 방식 | 주기 | 보관기간 |
|------|------|------|---------|
| PostgreSQL | pg_dump 전체 백업 | 일 1회 (야간) | 30일 |
| PostgreSQL | WAL 아카이브 (연속 백업) | 실시간 | 7일 |
| Redis | RDB Snapshot | 6시간 | 3일 |
| LPR 이미지 | NAS 파일 동기화 | 일 1회 | 90일 |
| 애플리케이션 로그 | ELK 수집 | 실시간 | 90일 |

### 7.4 모니터링
| 대상 | 도구 | 알림 조건 |
|------|------|----------|
| Application | Spring Actuator + Prometheus | API 응답 p95 > 1초, 에러율 > 1% |
| Database | pg_stat + Prometheus Exporter | Connection > 80%, 슬로우 쿼리 > 3초 |
| Redis | Redis Exporter | Memory > 80%, Connection > 90% |
| Infrastructure | Node Exporter + Prometheus | CPU > 80%, Memory > 85%, Disk > 90% |
| LPR 장비 | Custom Health Check | 연결 끊김, 인식률 < 90% |
| Log | ELK + Kibana | ERROR 로그 빈도 > 10건/분 |
| Nginx | Nginx Exporter | 5xx 에러율 > 0.5%, 응답지연 > 2초 |

### 7.5 장애 대응
| 시나리오 | 대응 방안 | RTO |
|---------|----------|-----|
| WAS 서버 장애 | Nginx 자동 failover (Active-Active) | < 30초 |
| DB Primary 장애 | PostgreSQL Standby 수동 승격 | < 30분 |
| Redis 장애 | DB 직접 조회 Fallback, Redis 재시작 | < 10분 |
| LPR 장비 장애 | 수동 계량 모드 전환 (터치스크린) | 즉시 |
| 네트워크 장애 | 계량대 CS 로컬 캐싱 후 복구 시 동기화 | < 1시간 |
| 전체 시스템 장애 | 수동 운영 전환 (기존 방식 병행) | 즉시 |

---

## 8. 기술 리스크 (Technical Risks)

| ID | 리스크 | 영향도 | 발생 가능성 | 대응 방안 |
|----|--------|--------|------------|----------|
| TR-001 | LPR 차량번호 인식률 미달 (환경적 요인: 야간, 우천, 오염 등) | HIGH | MEDIUM | AI 검증 이중화, 모바일 OTP 대체 프로세스 구축, 보조 조명 설치 |
| TR-002 | AI 인식 엔진 성능 지연 (3초 이내 목표 미달) | HIGH | LOW | 엔진 선정 시 벤치마크 수행, 로컬 GPU 서버 배치, 경량 모델 병행 |
| TR-003 | RS-232C 인디게이터 통신 불안정 | MEDIUM | MEDIUM | 통신 재시도 로직, 타임아웃 관리, 시리얼 포트 모니터링, 예비 컨버터 확보 |
| TR-004 | 기존 시스템 데이터 마이그레이션 실패 | HIGH | MEDIUM | 단계별 마이그레이션 (검증 구간 확보), 롤백 계획, 병행 운영 기간 |
| TR-005 | 카카오 API / SMS 외부 서비스 장애 | LOW | MEDIUM | 멀티 채널 (카카오 장애 시 SMS 대체), 재시도 큐, 서킷브레이커 |
| TR-006 | 동시 다수 차량 진입 시 계량 프로세스 병목 | MEDIUM | LOW | 비동기 이벤트 처리, 계량 큐 관리, 진입 순서 제어 (차단기) |
| TR-007 | 모바일 APP Push 알림 지연/미수신 | LOW | MEDIUM | FCM 고신뢰성 메시지 사용, 알림톡 보조, APP 폴링 fallback |
| TR-008 | Flutter 크로스 플랫폼 OS별 호환성 이슈 | MEDIUM | LOW | iOS/Android 네이티브 테스트 병행, CI 자동 빌드 테스트, 베타 테스트 |
| TR-009 | 계량대 CS 프로그램과 서버 간 네트워크 끊김 | HIGH | LOW | 로컬 캐싱 후 자동 동기화, 오프라인 모드 지원, 네트워크 이중화 |
| TR-010 | 보안 취약점 (OTP 탈취, 인증 우회) | HIGH | LOW | OTP TTL 5분 제한, IP 기반 접근 제어, 보안 감사 로그, 침투 테스트 |

---

## 9. 참고 문서

- 기반 PRD: `workspace/outputs/prd/PRD-20260127-154446.md`
- PRD JSON: `workspace/outputs/prd/PRD-20260127-154446.json`
- 원본 입력: `workspace/inputs/projects/부산 스마트 계량 시스템 구축 - 수행계획서.pptx`

---
*이 문서는 TRD 자동 생성 시스템에 의해 작성되었습니다.*
