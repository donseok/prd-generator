# 차량 계량대 시스템 기술 아키텍처 문서

## 1. 시스템 개요

### 1.1 목적
기존 DOS 기반 레거시 계량 시스템을 현대화하여 웹 기반 관리 시스템과 모바일 앱을 구축한다.

### 1.2 시스템 구성도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              클라우드 (AWS)                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   Web App   │  │   API GW    │  │  App Server │  │     RDS     │    │
│  │   (React)   │  │             │  │  (FastAPI)  │  │  (PostgreSQL)│   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
│         │                │                │                │            │
│         └────────────────┴────────────────┴────────────────┘            │
│                                    │                                     │
│  ┌─────────────┐           ┌─────────────┐           ┌─────────────┐   │
│  │    Redis    │           │     S3      │           │   CloudWatch│   │
│  │   (Cache)   │           │  (Storage)  │           │  (Logging)  │   │
│  └─────────────┘           └─────────────┘           └─────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ VPN
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                              현장 (On-Premise)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │ Edge Server │  │ Indicator#1 │  │ Indicator#2 │  │ Indicator#3 │   │
│  │  (데이터수집) │  │  (계량대1)   │  │  (계량대2)   │  │  (계량대3)   │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │
│         │              │ RS-232       │ RS-232       │ RS-232        │
│         └──────────────┴──────────────┴──────────────┘                │
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐                                      │
│  │   전광판     │  │   프린터     │                                      │
│  │  (순번표시)  │  │  (전표출력)  │                                      │
│  └─────────────┘  └─────────────┘                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

## 2. 기술 스택

### 2.1 Frontend (웹)

| 항목 | 기술 | 버전 | 비고 |
|------|------|------|------|
| Framework | React | 18.x | SPA |
| Language | TypeScript | 5.x | 타입 안정성 |
| UI Library | TailwindCSS | 3.x | 유틸리티 CSS |
| 상태관리 | Zustand | 4.x | 경량 상태관리 |
| 차트 | Recharts | 2.x | 대시보드 시각화 |
| HTTP Client | Axios | 1.x | API 통신 |
| 실시간 통신 | Socket.io-client | 4.x | 실시간 현황 |

### 2.2 Frontend (모바일)

| 항목 | 기술 | 버전 | 비고 |
|------|------|------|------|
| Framework | Flutter | 3.x | 크로스플랫폼 |
| Language | Dart | 3.x | |
| 상태관리 | Riverpod | 2.x | |
| Push | Firebase Cloud Messaging | | iOS/Android |
| Local Storage | Hive | 2.x | 오프라인 지원 |

### 2.3 Backend

| 항목 | 기술 | 버전 | 비고 |
|------|------|------|------|
| Framework | FastAPI | 0.100+ | Python 웹 프레임워크 |
| Language | Python | 3.11 | |
| ORM | SQLAlchemy | 2.x | 비동기 지원 |
| Task Queue | Celery | 5.x | 비동기 작업 |
| WebSocket | Socket.io | 5.x | 실시간 통신 |

### 2.4 Database & Cache

| 항목 | 기술 | 버전 | 비고 |
|------|------|------|------|
| RDBMS | PostgreSQL | 15.x | AWS RDS |
| Cache | Redis | 7.x | AWS ElastiCache |
| 파일저장소 | AWS S3 | | 전표 이미지 등 |

### 2.5 Edge Server (현장)

| 항목 | 기술 | 버전 | 비고 |
|------|------|------|------|
| OS | Ubuntu | 22.04 LTS | |
| Runtime | Python | 3.11 | 데이터 수집 |
| 시리얼통신 | pyserial | 3.x | RS-232 통신 |
| 로컬DB | SQLite | | 오프라인 버퍼 |

## 3. 인프라 구성

### 3.1 AWS 리소스

```yaml
VPC:
  CIDR: 10.0.0.0/16
  Subnets:
    - Public: 10.0.1.0/24, 10.0.2.0/24
    - Private: 10.0.10.0/24, 10.0.20.0/24

EC2:
  Web/API Server:
    Type: t3.medium
    Count: 2 (Auto Scaling)

RDS:
  Engine: PostgreSQL 15
  Type: db.t3.medium
  Multi-AZ: Yes
  Storage: 100GB (gp3)

ElastiCache:
  Engine: Redis 7.x
  Type: cache.t3.micro

S3:
  Buckets:
    - weighing-receipts (전표 이미지)
    - weighing-reports (리포트)

CloudFront:
  - Web 정적 파일 배포
```

### 3.2 네트워크

- **현장 ↔ 클라우드**: AWS Site-to-Site VPN
- **보안그룹**: 최소 권한 원칙 적용
- **WAF**: SQL Injection, XSS 방어

## 4. API 설계

### 4.1 주요 API 목록

#### 계량 관련
```
GET    /api/v1/weighings              # 계량 목록 조회
GET    /api/v1/weighings/{id}         # 계량 상세 조회
POST   /api/v1/weighings              # 계량 데이터 등록 (Edge→Cloud)
PUT    /api/v1/weighings/{id}         # 계량 데이터 수정

GET    /api/v1/weighings/statistics   # 통계 조회
GET    /api/v1/weighings/export       # 엑셀 다운로드
```

#### 대기열 관련
```
GET    /api/v1/queue                  # 현재 대기열 조회
POST   /api/v1/queue                  # 대기열 등록
PUT    /api/v1/queue/{id}/call        # 순번 호출
DELETE /api/v1/queue/{id}             # 대기열 취소

GET    /api/v1/queue/my               # 내 순번 조회 (모바일)
```

#### 차량/기사 관련
```
GET    /api/v1/vehicles               # 차량 목록
POST   /api/v1/vehicles               # 차량 등록
PUT    /api/v1/vehicles/{id}          # 차량 수정
DELETE /api/v1/vehicles/{id}          # 차량 삭제

GET    /api/v1/drivers                # 기사 목록
POST   /api/v1/drivers                # 기사 등록
PUT    /api/v1/drivers/{id}           # 기사 수정
```

### 4.2 WebSocket 이벤트

```javascript
// 서버 → 클라이언트
'queue:updated'      // 대기열 변경
'weighing:completed' // 계량 완료
'system:alert'       // 시스템 알림

// 클라이언트 → 서버
'queue:subscribe'    // 대기열 구독
'queue:unsubscribe'  // 구독 해제
```

## 5. 데이터베이스 스키마

### 5.1 ERD (주요 테이블)

```sql
-- 차량 정보
CREATE TABLE vehicles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    plate_number VARCHAR(20) NOT NULL UNIQUE,
    vehicle_type VARCHAR(50),
    empty_weight DECIMAL(10,2),
    max_load DECIMAL(10,2),
    company_id UUID REFERENCES companies(id),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 운전기사
CREATE TABLE drivers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    company_id UUID REFERENCES companies(id),
    vehicle_id UUID REFERENCES vehicles(id),
    app_user_id UUID REFERENCES app_users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 계량 데이터
CREATE TABLE weighings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    vehicle_id UUID REFERENCES vehicles(id),
    driver_id UUID REFERENCES drivers(id),
    scale_id INTEGER NOT NULL,
    gross_weight DECIMAL(10,2),
    tare_weight DECIMAL(10,2),
    net_weight DECIMAL(10,2) GENERATED ALWAYS AS (gross_weight - tare_weight) STORED,
    weighing_time TIMESTAMP NOT NULL,
    receipt_number VARCHAR(50),
    status VARCHAR(20) DEFAULT 'completed',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 대기열
CREATE TABLE queue (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    vehicle_id UUID REFERENCES vehicles(id),
    driver_id UUID REFERENCES drivers(id),
    queue_number INTEGER NOT NULL,
    status VARCHAR(20) DEFAULT 'waiting', -- waiting, called, processing, completed, cancelled
    registered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    called_at TIMESTAMP,
    completed_at TIMESTAMP
);
```

## 6. 보안 설계

### 6.1 인증/인가

- **웹**: JWT 기반 인증, Role-based Access Control
- **모바일 앱**: JWT + Refresh Token, 생체 인증 지원
- **API**: API Key (Edge Server용)

### 6.2 데이터 보호

- 전송 구간: TLS 1.3
- 저장 데이터: AES-256 암호화 (개인정보)
- 로그: 민감정보 마스킹

## 7. 모니터링 & 로깅

### 7.1 모니터링

- **인프라**: AWS CloudWatch
- **APM**: Datadog (또는 AWS X-Ray)
- **알림**: Slack 연동

### 7.2 로깅

- **중앙 로그**: CloudWatch Logs
- **로그 포맷**: JSON (구조화)
- **보관 기간**: 90일 (Hot) + 1년 (Cold/S3)

---

작성자: 최동훈 (개발팀 리드)
작성일: 2024-01-26
버전: 1.0
