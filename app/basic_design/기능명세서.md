# 기능명세서 (Functional Specification)
# PRD 자동 생성 시스템

**버전**: 1.0
**작성일**: 2026-01-22

---

## 1. 문서 관리 기능

### 1.1 파일 업로드 (FN-DOC-001)

**기능 설명**: 사용자가 다양한 형식의 파일을 시스템에 업로드

**입력**:
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| files | File[] | Y | 업로드할 파일 목록 |

**지원 파일 형식**:
| 형식 | 확장자 | 최대 크기 |
|------|--------|----------|
| 텍스트 | .txt, .md | 10MB |
| 이메일 | .eml | 10MB |
| 스프레드시트 | .xlsx, .csv | 50MB |
| 프레젠테이션 | .pptx | 50MB |
| 문서 | .docx, .pdf | 50MB |
| 이미지 | .png, .jpg, .gif | 20MB |

**처리 로직**:
1. 파일 확장자 검증
2. 파일 크기 검증 (개별 50MB, 총 200MB)
3. 파일 저장 (`/data/uploads/{doc_id}/`)
4. 메타데이터 추출 및 저장
5. InputDocument 객체 생성

**출력**:
```json
{
  "document_ids": ["doc-abc123", "doc-def456"],
  "uploaded_files": [
    {
      "id": "doc-abc123",
      "filename": "회의록.txt",
      "type": "text",
      "size": 2048
    }
  ]
}
```

**에러 코드**:
| 코드 | 설명 |
|------|------|
| 400 | 지원하지 않는 파일 형식 |
| 413 | 파일 크기 초과 |
| 500 | 서버 저장 오류 |

---

### 1.2 텍스트 입력 (FN-DOC-002)

**기능 설명**: 텍스트를 직접 입력하여 문서로 등록

**입력**:
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| text | string | Y | 입력 텍스트 (최대 50,000자) |
| title | string | N | 문서 제목 |

**처리 로직**:
1. 텍스트 길이 검증
2. ParsedContent 객체 생성
3. InputDocument 객체 생성

**출력**:
```json
{
  "document_id": "doc-xyz789",
  "type": "text",
  "content_length": 1500
}
```

---

## 2. 파싱 기능 (Layer 1)

### 2.1 문서 파싱 (FN-PARSE-001)

**기능 설명**: 업로드된 문서에서 텍스트와 구조화된 데이터 추출

**입력**: `InputDocument`

**처리 로직** (파서별):

#### TextParser
1. 파일 인코딩 감지 (UTF-8/CP949)
2. 텍스트 추출
3. 섹션 구분 (# 헤더, --- 구분선 등)

#### EmailParser
1. 이메일 헤더 파싱 (From, To, Subject, Date)
2. 본문 텍스트 추출
3. 첨부파일 목록 추출

#### ExcelParser
1. 시트 목록 추출
2. 각 시트별 데이터 프레임 변환
3. 헤더 행 식별
4. 텍스트 표현으로 변환

#### PPTParser
1. 슬라이드별 텍스트 추출
2. 노트 텍스트 추출
3. 슬라이드 번호 메타데이터

#### ImageParser
1. 이미지 크기/형식 추출
2. Claude AI를 통한 이미지 분석
3. 텍스트 내용 추출

#### DocumentParser (Word/PDF)
1. 문서 텍스트 추출
2. 페이지/섹션 구조 파싱
3. 메타데이터 추출

**출력**: `ParsedContent`
```json
{
  "raw_text": "추출된 전체 텍스트...",
  "structured_data": { "sheets": [...] },
  "metadata": {
    "filename": "data.xlsx",
    "sheet_names": ["Sheet1", "Sheet2"]
  },
  "sections": [
    { "title": "섹션 1", "content": "..." }
  ]
}
```

---

## 3. 정규화 기능 (Layer 2)

### 3.1 요구사항 추출 (FN-NORM-001)

**기능 설명**: 파싱된 내용에서 요구사항 후보 추출

**입력**: `List[ParsedContent]`

**처리 로직**:
1. Claude AI에 프롬프트 전송
2. 요구사항 후보 JSON 응답 파싱
3. 각 후보에 대해 정규화 수행

**Claude 프롬프트 구조**:
```
다음 내용에서 요구사항 후보를 추출해주세요.

=== 원본 내용 ===
{content_text}

=== 섹션 구조 ===
{sections_text}

요구사항 후보를 JSON 배열로 반환:
[
  {
    "title": "요구사항 제목",
    "description": "상세 설명",
    "type_hint": "FR|NFR|CONSTRAINT",
    "priority_hint": "HIGH|MEDIUM|LOW",
    "original_text": "원본에서 발췌한 텍스트"
  }
]
```

**출력**: 요구사항 후보 목록

---

### 3.2 요구사항 정규화 (FN-NORM-002)

**기능 설명**: 추출된 후보를 표준 형식으로 변환

**입력**: 요구사항 후보 1개

**처리 로직**:
1. 요구사항 유형 분류 (FR/NFR/CONSTRAINT)
2. 우선순위 결정 (HIGH/MEDIUM/LOW)
3. User Story 생성
4. Acceptance Criteria 생성
5. 신뢰도 점수 계산

**User Story 생성 프롬프트**:
```
다음 요구사항을 User Story와 Acceptance Criteria로 변환:

제목: {title}
설명: {description}

JSON 형식으로 응답:
{
  "user_story": "As a [user], I want [goal], so that [benefit]",
  "acceptance_criteria": ["조건1", "조건2", ...]
}
```

**출력**: `NormalizedRequirement`
```json
{
  "id": "REQ-001",
  "type": "FR",
  "title": "장바구니 수량 변경",
  "description": "사용자가 장바구니에서 상품 수량을 변경할 수 있어야 한다",
  "user_story": "As a 쇼핑몰 회원, I want 장바구니에서 수량을 변경하고 싶다, so that 원하는 수량만큼 구매할 수 있다",
  "acceptance_criteria": [
    "수량 +/- 버튼으로 조절 가능",
    "직접 숫자 입력 가능",
    "재고 초과 시 경고 표시"
  ],
  "priority": "HIGH",
  "confidence_score": 0.85,
  "confidence_reason": "명확한 요구사항, 구체적인 기능 설명",
  "source_reference": "회의록.txt:15"
}
```

---

### 3.3 신뢰도 점수 계산 (FN-NORM-003)

**기능 설명**: 요구사항의 품질을 0.0~1.0 점수로 평가

**입력**: 요구사항 후보, User Story, Acceptance Criteria

**평가 기준**:
| 기준 | 가중치 | 설명 |
|------|--------|------|
| 명확성 | 25% | 요구사항 설명의 명확도 |
| 완전성 | 25% | 필요한 정보 포함 여부 |
| 측정가능성 | 25% | 검증 가능한 조건 존재 여부 |
| 추적가능성 | 25% | 원본 출처 명확성 |

**출력**:
```json
{
  "score": 0.85,
  "reason": "명확한 요구사항, AC가 구체적임",
  "details": {
    "clarity": 0.9,
    "completeness": 0.8,
    "measurability": 0.85,
    "traceability": 0.85
  }
}
```

---

### 3.4 관계 분석 (FN-NORM-004)

**기능 설명**: 요구사항 간 관계 식별

**입력**: `List[NormalizedRequirement]`

**관계 유형**:
| 유형 | 설명 |
|------|------|
| depends_on | A가 B에 의존 |
| related_to | A와 B가 관련됨 |
| conflicts_with | A와 B가 충돌 |

**출력**: 관계 목록
```json
{
  "relationships": [
    {
      "from_id": "REQ-001",
      "to_id": "REQ-003",
      "type": "depends_on",
      "reason": "로그인 후 장바구니 사용 가능"
    }
  ]
}
```

---

## 4. 검증 기능 (Layer 3)

### 4.1 요구사항 검증 (FN-VAL-001)

**기능 설명**: 정규화된 요구사항의 품질 검증

**입력**: `List[NormalizedRequirement]`

**검증 항목**:

| 항목 | 설명 | 기준 |
|------|------|------|
| 완전성 | 필수 필드 존재 여부 | 모든 필드 값 존재 |
| 일관성 | 다른 요구사항과 충돌 여부 | 충돌 없음 |
| 추적성 | 원본 참조 존재 여부 | source_reference 존재 |
| 신뢰도 | AI 추출 신뢰도 | threshold (0.8) 이상 |

**출력**: `ValidationResult`
```json
{
  "requirement_id": "REQ-001",
  "is_valid": true,
  "completeness_score": 0.95,
  "consistency_issues": [],
  "traceability_score": 0.9,
  "needs_pm_review": false,
  "review_reasons": []
}
```

---

### 4.2 PM 검토 라우팅 (FN-VAL-002)

**기능 설명**: 검토가 필요한 항목을 PM 검토 대기열에 추가

**라우팅 조건**:
| 조건 | 검토 유형 |
|------|----------|
| confidence_score < 0.8 | LOW_CONFIDENCE |
| missing_info 존재 | MISSING_INFO |
| 충돌 감지 | CONFLICT |
| 모호한 표현 | AMBIGUOUS |

**출력**: `ReviewItem`
```json
{
  "id": "rev-001",
  "job_id": "job-abc",
  "requirement_id": "REQ-005",
  "issue_type": "LOW_CONFIDENCE",
  "description": "요구사항 설명이 모호합니다",
  "original_text": "시스템이 빠르게 동작해야 함",
  "suggested_resolution": "'빠르게'를 구체적인 응답 시간으로 정의해주세요 (예: 3초 이내)"
}
```

---

## 5. PM 검토 기능

### 5.1 검토 대기 목록 조회 (FN-REV-001)

**기능 설명**: 특정 작업의 PM 검토 대기 항목 조회

**입력**:
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| job_id | string | Y | 작업 ID |

**출력**:
```json
{
  "job_id": "job-abc",
  "pending_count": 3,
  "items": [
    {
      "id": "rev-001",
      "requirement_id": "REQ-005",
      "issue_type": "LOW_CONFIDENCE",
      "description": "..."
    }
  ]
}
```

---

### 5.2 검토 결정 제출 (FN-REV-002)

**기능 설명**: PM이 검토 항목에 대한 결정 제출

**입력**:
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| review_id | string | Y | 검토 항목 ID |
| decision | string | Y | approve / reject / modify |
| notes | string | N | 검토 의견 |
| modified_content | object | 조건부 | decision이 modify일 때 필수 |

**처리 로직**:
1. ReviewItem 조회
2. 결정 정보 저장
3. resolved = true 설정

**출력**:
```json
{
  "review_id": "rev-001",
  "decision": "modify",
  "resolved": true
}
```

---

### 5.3 검토 완료 및 재개 (FN-REV-003)

**기능 설명**: 모든 검토 완료 후 PRD 생성 재개

**입력**:
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| job_id | string | Y | 작업 ID |

**처리 로직**:
1. 모든 ReviewItem resolved 여부 확인
2. 검토 결정 적용
   - approve: 요구사항 유지
   - reject: 요구사항 제외
   - modify: 수정 내용 적용
3. Layer 4 (Generation) 실행
4. PRD 생성 및 저장

**출력**: `PRDDocument`

---

## 6. PRD 생성 기능 (Layer 4)

### 6.1 PRD 문서 생성 (FN-GEN-001)

**기능 설명**: 검증된 요구사항으로 PRD 문서 생성

**입력**: `List[NormalizedRequirement]`, 원본 문서 정보

**처리 로직**:
1. 요구사항 카테고리 분류
   - functional_requirements (FR)
   - non_functional_requirements (NFR)
   - constraints (CONSTRAINT)
2. Overview 섹션 생성 (Claude AI)
3. 마일스톤 자동 생성
4. 미해결 사항 정리
5. 메타데이터 설정

**Overview 생성 프롬프트**:
```
다음 요구사항 목록을 기반으로 PRD Overview 섹션을 생성:

요구사항:
{requirements_summary}

JSON 형식으로 응답:
{
  "background": "프로젝트 배경 설명",
  "goals": ["목표1", "목표2"],
  "scope": "프로젝트 범위",
  "out_of_scope": ["제외 항목"],
  "target_users": ["대상 사용자"],
  "success_metrics": ["성공 지표"]
}
```

**출력**: `PRDDocument`

---

### 6.2 PRD 내보내기 (FN-GEN-002)

**기능 설명**: PRD를 다양한 형식으로 내보내기

**입력**:
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| prd_id | string | Y | PRD ID |
| format | string | Y | markdown / json |

**출력 형식**:

#### Markdown
```markdown
# PRD 제목

**버전**: 1.0 | **상태**: draft | **신뢰도**: 85%

## 1. 개요
### 배경
...

## 2. 기능 요구사항 (FR)
### REQ-001: 제목
...
```

#### JSON
```json
{
  "id": "prd-123",
  "title": "PRD 제목",
  "overview": { ... },
  "functional_requirements": [ ... ],
  ...
}
```

---

## 7. 처리 상태 관리 기능

### 7.1 파이프라인 시작 (FN-PROC-001)

**기능 설명**: 문서 처리 파이프라인 시작

**입력**:
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| document_ids | string[] | Y | 처리할 문서 ID 목록 |

**처리 로직**:
1. ProcessingJob 생성 (status: PENDING)
2. 백그라운드 태스크로 파이프라인 실행
3. 각 레이어 실행 및 상태 업데이트

**출력**:
```json
{
  "job_id": "job-abc123",
  "status": "pending",
  "document_count": 3
}
```

---

### 7.2 처리 상태 조회 (FN-PROC-002)

**기능 설명**: 작업 처리 진행 상황 조회

**입력**:
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| job_id | string | Y | 작업 ID |

**출력**:
```json
{
  "job_id": "job-abc123",
  "status": "normalizing",
  "progress": {
    "current_layer": "normalizing",
    "completed_layers": 1,
    "total_layers": 4,
    "progress_percent": 25
  },
  "layer_results": {
    "parsing": {
      "status": "success",
      "duration_ms": 2500,
      "output_data": { "parsed_count": 3 }
    }
  },
  "requires_pm_review": false,
  "pending_reviews": 0
}
```

---

## 8. 에러 처리

### 8.1 공통 에러 코드

| HTTP 코드 | 에러 코드 | 설명 |
|-----------|----------|------|
| 400 | INVALID_INPUT | 입력 데이터 검증 실패 |
| 404 | NOT_FOUND | 리소스 없음 |
| 413 | FILE_TOO_LARGE | 파일 크기 초과 |
| 422 | PROCESSING_ERROR | 처리 중 오류 |
| 500 | INTERNAL_ERROR | 서버 내부 오류 |
| 503 | AI_SERVICE_ERROR | AI 서비스 오류 |

### 8.2 재시도 정책

| 상황 | 재시도 횟수 | 대기 시간 |
|------|-----------|----------|
| Claude AI 호출 실패 | 3회 | 지수 백오프 (2s, 4s, 8s) |
| 파일 읽기 실패 | 2회 | 1초 |
| 네트워크 오류 | 3회 | 2초 |
